---
title: "Fit fireSense ignition and escape modules in the NWT"
author: "Jean Marchal"
date: "March 7th, 2019"
output: html_document
---

Data comes from script fireSense_NWT_DataPrep (this will have to become generalized for any reagion in the WB);
Formula comes from several tested formulas in [script 2](https://github.com/tati-micheletti/NWT_Scripts/blob/master/2_Are%20the%20vegetation%20classes%20distinguishable%20according%20to%20the%20fire%20frequency%20model.Rmd)


```{R}
library(SpaDES)
setPaths(
  cachePath = "../cache",
  inputPath = "../inputs",
  modulePath = ".."
)
getPaths() # shows where the 4 relevant paths are
modules <- list("fireSense_NWT_DataPrep", "fireSense_FrequencyFit", "fireSense_EscapeFit")
cloudFolderID <- "https://drive.google.com/open?id=1PoEkOkg_ixnAdDqqTQcun77nUvkEHDc0"
start_year <- 1995
end_year <- 2015
times <- list(start = start_year, end = end_year)
inputs <- data.frame(
   files = dir(getPaths()$inputPath, pattern = "MDCs_.*_BCR6_NWT_250m[.]tif$"),
   functions = "raster::stack",
   objectName = "MDC_BCR6_NWT_250m",
   loadTime = start_year:end_year
)
objects <- list(
  cloudFolderID = cloudFolderID
)
parameters <- list(
  fireSense_NWT_DataPrep = list(res = 10000),
  fireSense_FrequencyFit = list(
    formula = formula(
      n_fires ~
        I(cl1 + cl6 + cl8 + cl9 + cl10):MDC06 +
        cl7:MDC06 +
        cl13:MDC06 +
        I(cl34 + cl35):MDC06 + I(cl34 + cl35):pw(MDC06, k_cl34_cl35) +
        I(cl16 + cl17 + cl18 + cl21 + cl22 + cl23 + cl24 + cl25 + cl26 + cl27 + cl28 + cl29 + cl30 + cl31 + cl32):MDC06 +
        cl20:MDC06 +
        I(cl2 + cl3 + cl4 + cl5 + cl11 + cl12 + cl14 + cl15):MDC06 +
        cl19:MDC06 + cl19:pw(MDC06, k_cl19) - 1
    ),
    family = negative.binomial(1, link = "identity"),
    ub = list(coef = 1),
    nCores = 8,
    itermax = itermax,
    nTrials = 500,
    trace = 5,
    .runInitialTime = 2015
  ),
  fireSense_EscapeFit = list(
    formula = cbind(escaped, n_fires) ~
      MDC06 +
      I(cl1 + cl6 + cl8 + cl9 + cl10) +
      cl7 +
      cl13 +
      I(cl34 + cl35) +
      I(cl16 + cl17 + cl18 + cl21 + cl22 + cl23 + cl24 + cl25 + cl26 + cl27 + cl28 + cl29 + cl30 + cl31 + cl32) +
      cl20 +
      I(cl2 + cl3 + cl4 + cl5 + cl11 + cl12 + cl14 + cl15) +
      cl19,
    .runInitialTime = 2015
  )
)
mySim <- simInit(
  inputs = inputs,
  objects = objects,
  times = times,
  params = parameters, 
  modules = modules,
  loadOrder = unlist(modules)
)
mySimOut <- spades(mySim)
mySimOut$fireSense_FrequencyFitted
mySimOut$fireSense_EscapeFitted
```