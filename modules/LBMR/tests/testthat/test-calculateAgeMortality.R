test_that("test process of age reclassification",{
  library(SpaDES)
  # define the module and path
  module <- list("Biomass_core")
  path <- list(modulePath="~/GitHub/nrv-succession/code blitz succession/Module_Biomass_core",
               outputPath="~/output")
  parameters <- list(.progress=list(type="graphical", interval=1),
                     .globals=list(verbose=FALSE),
                     Biomass_core=list( .saveInitialTime=NA))
  spinupMortalityfraction <- 0.001
  objects <- list()
  mySim <- simInit(times=list(start=0, end=1),
                   params=parameters,
                   modules=module,
                   objects=objects,
                   paths=path)
  # for the spin up stage test
  cohortData <- data.table(age = 2:496,
                           B = c(1096, 1854, 2626, 3391, 4140, 4868, 5574, 6256, 6915, 7551,
                                 8165, 8758, 9331, 9884, 10418, 10935, 11435, 11918, 12386, 12839,
                                 13278, 13703, 14115, 14514, 14901, 15277, 15642, 15996, 16340,
                                 16674, 16999, 17315, 17622, 17921, 18212, 18495, 18770, 19038,
                                 19299, 19553, 19801, 20042, 20277, 20506, 20729, 20947, 21159,
                                 21366, 21568, 21765, 21957, 22145, 22328, 22507, 22681, 22851,
                                 23017, 23179, 23337, 23492, 23643, 23791, 23935, 24076, 24214,
                                 24348, 24479, 24607, 24732, 24855, 24975, 25092, 25206, 25318,
                                 25427, 25534, 25638, 25740, 25840, 25937, 26032, 26125, 26216,
                                 26305, 26392, 26477, 26560, 26641, 26720, 26797, 26873, 26947,
                                 27019, 27089, 27158, 27225, 27291, 27355, 27418, 27479, 27539,
                                 27597, 27654, 27709, 27763, 27816, 27867, 27917, 27966, 28014,
                                 28060, 28105, 28149, 28192, 28234, 28275, 28315, 28354, 28392,
                                 28428, 28463, 28497, 28530, 28562, 28593, 28624, 28654, 28683,
                                 28711, 28738, 28764, 28789, 28813, 28836, 28858, 28880, 28901,
                                 28921, 28940, 28958, 28975, 28992, 29008, 29023, 29037, 29051,
                                 29064, 29076, 29087, 29097, 29107, 29116, 29124, 29131, 29138,
                                 29144, 29149, 29154, 29158, 29161, 29163, 29165, 29166, 29166,
                                 29166, 29166, 29165, 29163, 29161, 29158, 29154, 29149, 29144,
                                 29138, 29131, 29123, 29115, 29106, 29096, 29085, 29074, 29062,
                                 29049, 29035, 29021, 29006, 28990, 28973, 28956, 28938, 28919,
                                 28899, 28878, 28857, 28835, 28812, 28788, 28763, 28737, 28711,
                                 28684, 28656, 28627, 28597, 28566, 28534, 28501, 28468, 28434,
                                 28399, 28363, 28326, 28288, 28249, 28209, 28168, 28126, 28083,
                                 28039, 27994, 27948, 27901, 27853, 27804, 27754, 27703, 27651,
                                 27598, 27543, 27487, 27430, 27372, 27313, 27253, 27192, 27129,
                                 27065, 27000, 26934, 26867, 26798, 26728, 26657, 26585, 26511,
                                 26436, 26360, 26282, 26203, 26123, 26042, 25959, 25875, 25790,
                                 25703, 25615, 25525, 25434, 25342, 25248, 25153, 25056, 24958,
                                 24859, 24758, 24656, 24552, 24447, 24340, 24232, 24123, 24012,
                                 23900, 23786, 23671, 23554, 23436, 23317, 23196, 23074, 22950,
                                 22825, 22699, 22571, 22442, 22311, 22179, 22046, 21911, 21775,
                                 21638, 21499, 21359, 21218, 21076, 20932, 20787, 20641, 20494,
                                 20346, 20197, 20046, 19894, 19741, 19587, 19432, 19276, 19119,
                                 18962, 18804, 18645, 18485, 18324, 18163, 18001, 17838, 17675,
                                 17511, 17346, 17181, 17015, 16849, 16683, 16516, 16349, 16182,
                                 16015, 15847, 15679, 15511, 15343, 15175, 15007, 14839, 14672,
                                 14505, 14338, 14171, 14005, 13839, 13673, 13508, 13343, 13179,
                                 13015, 12852, 12689, 12518, 12339, 12152, 11959, 11760, 11557,
                                 11350, 11140, 10927, 10713, 10498, 10282, 10066, 9851, 9637,
                                 9424, 9213, 9004, 8797, 8593, 8392, 8194, 7999, 7808, 7620, 7436,
                                 7256, 7080, 6907, 6738, 6573, 6412, 6255, 6102, 5952, 5806, 5664,
                                 5525, 5390, 5258, 5129, 5004, 4882, 4763, 4647, 4534, 4424, 4317,
                                 4213, 4111, 4012, 3915, 3821, 3729, 3639, 3552, 3467, 3384, 3303,
                                 3224, 3147, 3072, 2998, 2926, 2856, 2788, 2722, 2657, 2594, 2532,
                                 2472, 2413, 2356, 2300, 2245, 2192, 2140, 2089, 2040, 1992, 1945,
                                 1899, 1854, 1810, 1767, 1725, 1684, 1644, 1605, 1567, 1530, 1494,
                                 1458, 1424, 1390, 1357, 1325, 1294, 1263, 1233, 1204, 1175, 1147,
                                 1120, 1093, 1067, 1042, 1017, 993, 970, 947, 924, 902, 881, 860,
                                 840, 820, 800, 781, 762, 744, 727, 709, 692, 676, 660, 644, 629,
                                 614, 599, 585, 571, 557, 544, 531, 518, 506, 494, 482, 470, 459,
                                 448, 437, 427, 416, 407, 397, 387),
                           longevity = 500, mortalityshape = 10)
  if(exists("calculateAgeMortality")){
    output <- calculateAgeMortality(cohortData, stage="spinup", spinupMortalityfraction)
  } else {
    output <- mySim$calculateAgeMortality(cohortData, stage="spinup", spinupMortalityfraction)
  }
  cohortData_output <- output[,.(age,mAge=round(mAge,2))]
  cohortData_output_compared <- data.table(age = 2:496, mAge = c(1.15, 1.94, 2.76, 3.56, 4.35, 5.12, 5.87, 6.6, 7.3, 7.98, 8.64,
                               9.27, 9.89, 10.49, 11.07, 11.63, 12.18, 12.71, 13.22, 13.73,
                               14.21, 14.69, 15.15, 15.6, 16.04, 16.47, 16.89, 17.29, 17.69,
                               18.08, 18.46, 18.84, 19.2, 19.56, 19.91, 20.25, 20.59, 20.92,
                               21.25, 21.57, 21.88, 22.19, 22.5, 22.8, 23.09, 23.38, 23.67,
                               23.95, 24.23, 24.51, 24.78, 25.05, 25.31, 25.58, 25.84, 26.09,
                               26.35, 26.6, 26.85, 27.1, 27.35, 27.6, 27.84, 28.09, 28.33, 28.57,
                               28.81, 29.05, 29.29, 29.52, 29.76, 30, 30.23, 30.47, 30.71, 30.94,
                               31.18, 31.41, 31.65, 31.89, 32.12, 32.36, 32.6, 32.84, 33.08,
                               33.33, 33.57, 33.81, 34.06, 34.31, 34.55, 34.81, 35.06, 35.31,
                               35.57, 35.83, 36.09, 36.35, 36.62, 36.88, 37.15, 37.43, 37.7,
                               37.98, 38.26, 38.55, 38.84, 39.13, 39.42, 39.72, 40.03, 40.33,
                               40.64, 40.96, 41.28, 41.6, 41.93, 42.26, 42.6, 42.94, 43.29,
                               43.64, 44, 44.36, 44.73, 45.1, 45.48, 45.87, 46.26, 46.66, 47.06,
                               47.47, 47.89, 48.32, 48.75, 49.19, 49.63, 50.09, 50.55, 51.01,
                               51.49, 51.98, 52.47, 52.97, 53.48, 54, 54.53, 55.06, 55.61, 56.17,
                               56.73, 57.31, 57.89, 58.49, 59.1, 59.71, 60.34, 60.98, 61.63,
                               62.3, 62.97, 63.66, 64.36, 65.07, 65.79, 66.53, 67.28, 68.05,
                               68.83, 69.62, 70.43, 71.25, 72.09, 72.95, 73.81, 74.69, 75.59,
                               76.51, 77.44, 78.39, 79.35, 80.34, 81.34, 82.35, 83.39, 84.44,
                               85.52, 86.61, 87.72, 88.85, 90, 91.17, 92.37, 93.58, 94.81, 96.07,
                               97.35, 98.65, 99.97, 101.32, 102.69, 104.08, 105.5, 106.94, 108.4,
                               109.89, 111.41, 112.95, 114.52, 116.12, 117.74, 119.39, 121.06,
                               122.77, 124.5, 126.26, 128.05, 129.87, 131.72, 133.6, 135.51,
                               137.46, 139.43, 141.43, 143.47, 145.54, 147.64, 149.78, 151.94,
                               154.14, 156.38, 158.64, 160.95, 163.29, 165.67, 168.07, 170.52,
                               173, 175.52, 178.07, 180.66, 183.29, 185.96, 188.67, 191.41,
                               194.19, 197.01, 199.86, 202.76, 205.69, 208.67, 211.69, 214.74,
                               217.84, 220.97, 224.14, 227.35, 230.6, 233.9, 237.23, 240.6,
                               244.01, 247.46, 250.96, 254.49, 258.06, 261.67, 265.32, 269,
                               272.73, 276.5, 280.3, 284.15, 288.02, 291.94, 295.89, 299.89,
                               303.92, 307.98, 312.08, 316.21, 320.38, 324.59, 328.83, 333.1,
                               337.39, 341.72, 346.09, 350.48, 354.9, 359.35, 363.82, 368.33,
                               372.86, 377.42, 381.99, 386.59, 391.21, 395.85, 400.52, 405.21,
                               409.9, 414.61, 419.34, 424.07, 428.83, 433.59, 438.36, 443.16,
                               447.96, 452.77, 457.58, 462.39, 467.22, 472.04, 476.85, 481.69,
                               486.5, 491.3, 496.11, 500.9, 505.69, 510.49, 515.26, 520.02,
                               524.78, 529.53, 534.24, 538.94, 543.62, 548.29, 552.93, 557.55,
                               562.15, 566.75, 571.33, 575.87, 580.37, 584.88, 589.34, 593.76,
                               598.17, 602.53, 606.88, 611.17, 615.45, 619.67, 623.41, 626.66,
                               629.39, 631.66, 633.46, 634.87, 635.86, 636.48, 636.7, 636.63,
                               636.24, 635.53, 634.55, 633.34, 631.9, 630.23, 628.38, 626.35,
                               624.13, 621.8, 619.35, 616.79, 614.12, 611.4, 608.58, 605.73,
                               602.86, 599.98, 597.01, 594.03, 591.05, 588.1, 585.16, 582.25,
                               579.29, 576.38, 573.53, 570.65, 567.84, 565.02, 562.19, 559.46,
                               556.75, 554.06, 551.39, 548.76, 546.17, 543.64, 541.18, 538.66,
                               536.23, 533.75, 531.38, 528.99, 526.58, 524.3, 522.02, 519.75,
                               517.49, 515.25, 513.04, 510.87, 508.58, 506.33, 504.14, 502.02,
                               499.99, 497.85, 495.81, 493.69, 491.68, 489.59, 487.63, 485.61,
                               483.53, 481.61, 479.64, 477.62, 475.8, 473.95, 472.08, 470.19,
                               468.28, 466.37, 464.45, 462.53, 460.63, 458.74, 456.87, 455.03,
                               453.23, 451.48, 449.47, 447.83, 445.94, 444.12, 442.38, 440.73,
                               438.84, 437.04, 435.36, 433.43, 431.63, 429.96, 428.05, 426.29,
                               424.69, 422.85, 421.19, 419.73, 418.04, 416.1, 414.38, 412.9,
                               411.18, 409.71, 408.02, 406.09, 404.44, 402.56, 400.97, 399.71,
                               397.68, 395.97, 394.61, 393.04, 391.25, 389.84, 388.22, 386.38,
                               384.96, 383.32, 381.47, 380.08, 378.48, 376.66, 375.36, 373.85,
                               372.13, 370.19, 368.82, 367.24, 365.45, 364.29, 362.07, 361.38,
                               359.62, 357.63))
  expect_equal(cohortData_output,cohortData_output_compared)
  rm(cohortData,cohortData_output,cohortData_output_compared)


  # for the main simulation stage test
  cohortData <- data.table(age=2:452,
                           B=c(1096, 1855, 2629, 3397, 4149, 4881, 5591, 6278, 6943, 7585,
                               8206, 8806, 9386, 9947, 10489, 11014, 11522, 12014, 12491, 12953,
                               13401, 13836, 14258, 14667, 15065, 15451, 15826, 16191, 16546,
                               16891, 17227, 17554, 17872, 18182, 18484, 18778, 19065, 19344,
                               19616, 19882, 20141, 20394, 20641, 20882, 21117, 21346, 21570,
                               21789, 22003, 22212, 22416, 22615, 22810, 23000, 23186, 23368,
                               23546, 23720, 23890, 24056, 24218, 24377, 24532, 24684, 24833,
                               24978, 25120, 25259, 25395, 25528, 25659, 25787, 25912, 26034,
                               26154, 26271, 26386, 26498, 26608, 26716, 26821, 26924, 27025,
                               27124, 27221, 27316, 27409, 27500, 27589, 27676, 27761, 27844,
                               27925, 28005, 28083, 28159, 28234, 28307, 28378, 28448, 28516,
                               28583, 28648, 28712, 28774, 28835, 28895, 28953, 29010, 29066,
                               29120, 29173, 29225, 29276, 29325, 29373, 29420, 29466, 29511,
                               29555, 29597, 29638, 29678, 29717, 29755, 29792, 29828, 29863,
                               29897, 29930, 29962, 29993, 30023, 30052, 30080, 30107, 30133,
                               30158, 30183, 30207, 30230, 30252, 30273, 30293, 30312, 30330,
                               30347, 30364, 30380, 30395, 30409, 30422, 30434, 30446, 30457,
                               30467, 30476, 30484, 30491, 30498, 30504, 30509, 30513, 30516,
                               30519, 30521, 30522, 30522, 30522, 30522, 30521, 30519, 30516,
                               30512, 30507, 30502, 30496, 30489, 30481, 30472, 30462, 30451,
                               30440, 30428, 30415, 30401, 30386, 30370, 30353, 30335, 30317,
                               30298, 30278, 30257, 30235, 30212, 30188, 30163, 30137, 30110,
                               30082, 30053, 30023, 29992, 29960, 29927, 29893, 29858, 29822,
                               29785, 29747, 29708, 29668, 29627, 29585, 29542, 29498, 29453,
                               29407, 29359, 29310, 29260, 29209, 29157, 29104, 29049, 28993,
                               28936, 28878, 28819, 28758, 28696, 28633, 28568, 28502, 28435,
                               28367, 28297, 28226, 28153, 28079, 28004, 27927, 27849, 27770,
                               27689, 27607, 27523, 27438, 27351, 27263, 27173, 27082, 26990,
                               26896, 26801, 26704, 26605, 26505, 26403, 26300, 26195, 26089,
                               25981, 25872, 25761, 25649, 25535, 25420, 25303, 25184, 25064,
                               24942, 24819, 24694, 24568, 24440, 24311, 24180, 24048, 23914,
                               23779, 23642, 23504, 23364, 23223, 23080, 22936, 22790, 22643,
                               22495, 22345, 22194, 22042, 21888, 21733, 21577, 21419, 21260,
                               21100, 20939, 20777, 20614, 20450, 20285, 20119, 19952, 19784,
                               19615, 19445, 19274, 19102, 18930, 18757, 18583, 18409, 18234,
                               18059, 17883, 17707, 17530, 17353, 17176, 16998, 16820, 16642,
                               16464, 16286, 16108, 15930, 15752, 15574, 15396, 15218, 15041,
                               14864, 14687, 14511, 14335, 14160, 13985, 13811, 13638, 13465,
                               13293, 13122, 12951, 12781, 12602, 12415, 12221, 12020, 11814,
                               11604, 11390, 11173, 10954, 10733, 10512, 10290, 10068, 9847,
                               9628, 9410, 9194, 8981, 8770, 8562, 8358, 8157, 7959, 7765, 7575,
                               7389, 7207, 7029, 6855, 6685, 6519, 6357, 6199, 6045, 5894, 5747,
                               5604, 5465, 5329, 5197, 5069, 4944, 4822, 4703, 4587, 4475, 4365,
                               4258, 4154, 4053, 3954, 3858, 3764, 3673, 3584, 3497, 3413, 3331,
                               3251, 3172, 3096, 3021, 2948, 2877, 2808, 2741, 2675, 2611, 2549,
                               2488, 2429, 2371, 2314, 2259, 2205, 2152, 2101, 2051, 2002, 1954,
                               1908, 1863, 1818, 1775, 1733, 1692, 1652, 1612, 1574, 1536, 1500,
                               1464, 1429, 1395, 1362, 1330, 1298, 1267, 1237, 1208, 1179, 1151,
                               1124),
                           longevity = 500, mortalityshape = 10)
  if(exists("calculateAgeMortality")){
    output <- calculateAgeMortality(cohortData, stage="mainsimulation", spinupMortalityfraction)
  } else {
    output <- mySim$calculateAgeMortality(cohortData,stage="mainsimulation", spinupMortalityfraction)
  }
  cohortData_output <- output[,.(age,mAge=round(mAge,2))]
  cohortData_output_compared <- data.table(age = 2:452,
                                           mAge=c(0.05, 0.09, 0.13, 0.17, 0.21, 0.25, 0.3, 0.34, 0.39, 0.43,
                                                  0.47, 0.52, 0.56, 0.61, 0.66, 0.7, 0.75, 0.8, 0.85, 0.9, 0.94,
                                                  1, 1.05, 1.1, 1.15, 1.2, 1.26, 1.31, 1.37, 1.43, 1.48, 1.54,
                                                  1.6, 1.66, 1.72, 1.79, 1.85, 1.92, 1.98, 2.05, 2.12, 2.19, 2.26,
                                                  2.33, 2.41, 2.48, 2.56, 2.64, 2.72, 2.8, 2.88, 2.96, 3.05, 3.14,
                                                  3.23, 3.32, 3.41, 3.5, 3.6, 3.7, 3.8, 3.9, 4.01, 4.11, 4.22,
                                                  4.33, 4.44, 4.56, 4.68, 4.79, 4.92, 5.04, 5.17, 5.3, 5.43, 5.56,
                                                  5.7, 5.84, 5.98, 6.13, 6.28, 6.43, 6.58, 6.74, 6.9, 7.07, 7.23,
                                                  7.4, 7.58, 7.75, 7.94, 8.12, 8.31, 8.5, 8.7, 8.9, 9.1, 9.31,
                                                  9.52, 9.74, 9.96, 10.18, 10.41, 10.64, 10.88, 11.13, 11.38, 11.63,
                                                  11.89, 12.15, 12.42, 12.69, 12.97, 13.26, 13.55, 13.84, 14.15,
                                                  14.45, 14.77, 15.09, 15.42, 15.75, 16.09, 16.44, 16.79, 17.15,
                                                  17.52, 17.89, 18.27, 18.66, 19.06, 19.47, 19.88, 20.3, 20.73,
                                                  21.17, 21.61, 22.07, 22.53, 23.01, 23.49, 23.98, 24.48, 24.99,
                                                  25.52, 26.05, 26.59, 27.14, 27.7, 28.28, 28.86, 29.46, 30.06,
                                                  30.68, 31.31, 31.96, 32.61, 33.28, 33.96, 34.65, 35.36, 36.08,
                                                  36.82, 37.56, 38.33, 39.1, 39.89, 40.7, 41.52, 42.36, 43.21,
                                                  44.08, 44.97, 45.87, 46.79, 47.73, 48.68, 49.66, 50.65, 51.65,
                                                  52.68, 53.72, 54.79, 55.88, 56.98, 58.1, 59.25, 60.41, 61.6,
                                                  62.81, 64.04, 65.29, 66.56, 67.86, 69.18, 70.53, 71.89, 73.29,
                                                  74.7, 76.14, 77.61, 79.1, 80.62, 82.16, 83.73, 85.33, 86.95,
                                                  88.61, 90.29, 92, 93.74, 95.5, 97.3, 99.13, 100.99, 102.88, 104.8,
                                                  106.76, 108.74, 110.76, 112.81, 114.89, 117.01, 119.16, 121.34,
                                                  123.56, 125.81, 128.1, 130.43, 132.79, 135.19, 137.62, 140.09,
                                                  142.6, 145.14, 147.73, 150.35, 153.01, 155.71, 158.45, 161.22,
                                                  164.04, 166.89, 169.79, 172.73, 175.7, 178.72, 181.78, 184.88,
                                                  188.01, 191.19, 194.41, 197.68, 200.98, 204.33, 207.72, 211.15,
                                                  214.62, 218.13, 221.68, 225.28, 228.91, 232.59, 236.3, 240.07,
                                                  243.87, 247.71, 251.59, 255.52, 259.48, 263.48, 267.52, 271.59,
                                                  275.71, 279.87, 284.06, 288.29, 292.56, 296.87, 301.21, 305.58,
                                                  310, 314.44, 318.92, 323.42, 327.96, 332.53, 337.13, 341.75,
                                                  346.4, 351.09, 355.8, 360.53, 365.29, 370.07, 374.87, 379.7,
                                                  384.53, 389.39, 394.27, 399.16, 404.08, 409, 413.95, 418.9, 423.87,
                                                  428.84, 433.82, 438.8, 443.79, 448.77, 453.75, 458.75, 463.74,
                                                  468.72, 473.71, 478.69, 483.67, 488.63, 493.59, 498.53, 503.47,
                                                  508.4, 513.3, 518.18, 523.05, 527.91, 532.75, 537.58, 542.38,
                                                  547.15, 551.9, 556.61, 561.29, 565.97, 570.61, 575.2, 579.79,
                                                  584.33, 588.85, 593.32, 597.78, 602.22, 606.59, 610.94, 615.26,
                                                  619.51, 623.73, 627.42, 630.59, 633.28, 635.45, 637.17, 638.49,
                                                  639.37, 639.86, 639.99, 639.75, 639.24, 638.38, 637.22, 635.82,
                                                  634.24, 632.4, 630.37, 628.2, 625.84, 623.34, 620.78, 618.09,
                                                  615.27, 612.4, 609.48, 606.53, 603.54, 600.52, 597.49, 594.44,
                                                  591.39, 588.34, 585.31, 582.3, 579.22, 576.19, 573.2, 570.28,
                                                  567.32, 564.44, 561.66, 558.88, 556.1, 553.33, 550.59, 547.99,
                                                  545.32, 542.7, 540.14, 537.65, 535.12, 532.67, 530.19, 527.82,
                                                  525.44, 523.04, 520.79, 518.55, 516.32, 513.95, 511.77, 509.46,
                                                  507.19, 504.97, 502.82, 500.74, 498.55, 496.45, 494.46, 492.37,
                                                  490.41, 488.37, 486.25, 484.29, 482.26, 480.18, 478.27, 476.32,
                                                  474.33, 472.31, 470.51, 468.69, 466.61, 464.78, 462.95, 461.12,
                                                  459.32, 457.25, 455.49, 453.47, 451.79, 449.86, 447.97, 446.15,
                                                  444.39, 442.72, 440.79, 438.96, 437.22, 435.6, 433.73, 431.98,
                                                  430.37))
  expect_equal(cohortData_output,cohortData_output_compared)
})
