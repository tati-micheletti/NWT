test_that("test scheduled time for age classification and sumB at spinup stage",{
  library(SpaDES)
  # define the module and path
  module <- list("Biomass_core")
  path <- list(modulePath="~/GitHub/nrv-succession/code blitz succession/Module_Biomass_core",
               outputPath="~/output")
  parameters <- list(.progress=list(type="graphical", interval=1),
                     .globals=list(verbose=FALSE),
                     Biomass_core=list( .saveInitialTime=NA))
  spinupMortalityfraction <- 0.001
  calibrate <- TRUE
  successionTimestep <- 1
  objects <- list()
  mySim <- simInit(times=list(start=0, end=1),
                   params=parameters,
                   modules=module,
                   objects=objects,
                   paths=path)
  species <- data.table(species = c("abiebals", "acerrubr", "acersacc", "betualle", "betupapy", "fraxamer",
                                    "piceglau", "pinubank", "pinuresi", "pinustro", "poputrem", "querelli",
                                    "querrubr", "thujocci", "tiliamer", "tsugcana"),
                        speciesCode = 1:16)
  cohortData <- data.table(pixelGroup = 1, ecoregionGroup = 1L,
                           speciesCode = 16, age = 492, B = 0L, maxANPP = 1096L,
                           maxB = 32880L, maxB_eco = 38150L,
                           longevity = 500L, mortalityshape = 10L,
                           growthcurve = 0.25)
  if(exists("spinUp")){
    output <- spinUp(cohortData, calibrate, successionTimestep, spinupMortalityfraction, species)
  } else {
    output <- mySim$spinUp(cohortData, calibrate, successionTimestep, spinupMortalityfraction, species)
  }
  age <- output$spinupOutput$age
  age_compared <- seq(2,492)
  expect_equal(age,age_compared)
  sumB <- output$spinupOutput$iniBiomass
  sumB_compared <- c(1096, 1854, 2626, 3391, 4140, 4868, 5574, 6256, 6915, 7551,
                     8165, 8758, 9331, 9884, 10418, 10935, 11435, 11918, 12386, 12839,
                     13278, 13703, 14115, 14514, 14901, 15277, 15642, 15996, 16340,
                     16674, 16999, 17315, 17622, 17921, 18212, 18495, 18770, 19038,
                     19299, 19553, 19801, 20042, 20277, 20506, 20729, 20947, 21159,
                     21366, 21568, 21765, 21957, 22145, 22328, 22507, 22681, 22851,
                     23017, 23179, 23337, 23492, 23643, 23791, 23935, 24076, 24214,
                     24348, 24479, 24607, 24732, 24855, 24975, 25092, 25206, 25318,
                     25427, 25534, 25638, 25740, 25840, 25937, 26032, 26125, 26216,
                     26305, 26392, 26477, 26560, 26641, 26720, 26797, 26873, 26947,
                     27019, 27089, 27158, 27225, 27291, 27355, 27418, 27479, 27539,
                     27597, 27654, 27709, 27763, 27816, 27867, 27917, 27966, 28014,
                     28060, 28105, 28149, 28192, 28234, 28275, 28315, 28354, 28392,
                     28428, 28463, 28497, 28530, 28562, 28593, 28624, 28654, 28683,
                     28711, 28738, 28764, 28789, 28813, 28836, 28858, 28880, 28901,
                     28921, 28940, 28958, 28975, 28992, 29008, 29023, 29037, 29051,
                     29064, 29076, 29087, 29097, 29107, 29116, 29124, 29131, 29138,
                     29144, 29149, 29154, 29158, 29161, 29163, 29165, 29166, 29166,
                     29166, 29166, 29165, 29163, 29161, 29158, 29154, 29149, 29144,
                     29138, 29131, 29123, 29115, 29106, 29096, 29085, 29074, 29062,
                     29049, 29035, 29021, 29006, 28990, 28973, 28956, 28938, 28919,
                     28899, 28878, 28857, 28835, 28812, 28788, 28763, 28737, 28711,
                     28684, 28656, 28627, 28597, 28566, 28534, 28501, 28468, 28434,
                     28399, 28363, 28326, 28288, 28249, 28209, 28168, 28126, 28083,
                     28039, 27994, 27948, 27901, 27853, 27804, 27754, 27703, 27651,
                     27598, 27543, 27487, 27430, 27372, 27313, 27253, 27192, 27129,
                     27065, 27000, 26934, 26867, 26798, 26728, 26657, 26585, 26511,
                     26436, 26360, 26282, 26203, 26123, 26042, 25959, 25875, 25790,
                     25703, 25615, 25525, 25434, 25342, 25248, 25153, 25056, 24958,
                     24859, 24758, 24656, 24552, 24447, 24340, 24232, 24123, 24012,
                     23900, 23786, 23671, 23554, 23436, 23317, 23196, 23074, 22950,
                     22825, 22699, 22571, 22442, 22311, 22179, 22046, 21911, 21775,
                     21638, 21499, 21359, 21218, 21076, 20932, 20787, 20641, 20494,
                     20346, 20197, 20046, 19894, 19741, 19587, 19432, 19276, 19119,
                     18962, 18804, 18645, 18485, 18324, 18163, 18001, 17838, 17675,
                     17511, 17346, 17181, 17015, 16849, 16683, 16516, 16349, 16182,
                     16015, 15847, 15679, 15511, 15343, 15175, 15007, 14839, 14672,
                     14505, 14338, 14171, 14005, 13839, 13673, 13508, 13343, 13179,
                     13015, 12852, 12689, 12518, 12339, 12152, 11959, 11760, 11557,
                     11350, 11140, 10927, 10713, 10498, 10282, 10066, 9851, 9637,
                     9424, 9213, 9004, 8797, 8593, 8392, 8194, 7999, 7808, 7620, 7436,
                     7256, 7080, 6907, 6738, 6573, 6412, 6255, 6102, 5952, 5806, 5664,
                     5525, 5390, 5258, 5129, 5004, 4882, 4763, 4647, 4534, 4424, 4317,
                     4213, 4111, 4012, 3915, 3821, 3729, 3639, 3552, 3467, 3384, 3303,
                     3224, 3147, 3072, 2998, 2926, 2856, 2788, 2722, 2657, 2594, 2532,
                     2472, 2413, 2356, 2300, 2245, 2192, 2140, 2089, 2040, 1992, 1945,
                     1899, 1854, 1810, 1767, 1725, 1684, 1644, 1605, 1567, 1530, 1494,
                     1458, 1424, 1390, 1357, 1325, 1294, 1263, 1233, 1204, 1175, 1147,
                     1120, 1093, 1067, 1042, 1017, 993, 970, 947, 924, 902, 881, 860,
                     840, 820, 800, 781, 762, 744, 727, 709, 692, 676, 660, 644, 629,
                     614, 599, 585, 571, 557, 544, 531, 518, 506, 494, 482, 470, 459,
                     448, 437, 427)
  expect_equal(sumB,sumB_compared)
  rm(output,age,age_compared,sumB,sumB_compared)

  successionTimestep <- 4
  mySim <- simInit(times=list(start=0, end=1),
                   params=parameters,
                   modules=module,
                   objects=objects,
                   paths=path)
  cohortData <- data.table(pixelGroup = 1, ecoregionGroup = 1L,
                           speciesCode = 16, age = 492, B = 0L,
                           maxANPP = 1096L, maxB = 32880L,
                           maxB_eco = 38150L, longevity = 500L,
                           mortalityshape = 10L, growthcurve = 0.25)
  if(exists("spinUp")){
    output <- spinUp(cohortData, calibrate, successionTimestep, spinupMortalityfraction, species)
  } else {
    output <- mySim$spinUp(cohortData, calibrate, successionTimestep, spinupMortalityfraction, species)
  }
  age <- output$spinupOutput$age
  age_compared <- c(2:4,4:492)
  expect_equal(age,age_compared)
  sumB <- output$spinupOutput$iniBiomass
  sumB_compared <- c(1096, 1852, 2624, 3392, 4141, 4869, 5575, 6257, 6916, 7552,
                     8166, 8759, 9332, 9885, 10419, 10936, 11435, 11918, 12386, 12839,
                     13278, 13703, 14115, 14514, 14901, 15277, 15642, 15996, 16340,
                     16674, 16999, 17315, 17622, 17921, 18212, 18495, 18770, 19038,
                     19299, 19553, 19801, 20042, 20277, 20506, 20729, 20947, 21159,
                     21366, 21568, 21765, 21957, 22145, 22328, 22507, 22681, 22851,
                     23017, 23179, 23338, 23493, 23644, 23792, 23936, 24077, 24215,
                     24349, 24480, 24608, 24733, 24856, 24976, 25093, 25207, 25319,
                     25428, 25535, 25639, 25741, 25841, 25938, 26033, 26126, 26217,
                     26306, 26393, 26478, 26561, 26642, 26721, 26798, 26874, 26948,
                     27020, 27091, 27160, 27227, 27293, 27357, 27420, 27481, 27541,
                     27599, 27656, 27712, 27766, 27819, 27871, 27921, 27970, 28018,
                     28065, 28110, 28154, 28197, 28239, 28280, 28320, 28359, 28397,
                     28434, 28470, 28505, 28539, 28572, 28604, 28635, 28665, 28694,
                     28722, 28749, 28775, 28800, 28824, 28847, 28870, 28892, 28913,
                     28933, 28952, 28970, 28988, 29005, 29021, 29036, 29051, 29065,
                     29078, 29090, 29101, 29112, 29122, 29131, 29139, 29147, 29154,
                     29160, 29166, 29171, 29175, 29178, 29181, 29183, 29184, 29185,
                     29185, 29185, 29184, 29183, 29181, 29178, 29175, 29171, 29166,
                     29160, 29154, 29147, 29139, 29130, 29121, 29111, 29100, 29088,
                     29076, 29063, 29049, 29034, 29019, 29003, 28986, 28968, 28950,
                     28931, 28911, 28890, 28868, 28846, 28823, 28799, 28774, 28748,
                     28721, 28694, 28666, 28637, 28607, 28576, 28544, 28511, 28477,
                     28442, 28407, 28371, 28334, 28296, 28257, 28217, 28176, 28134,
                     28091, 28047, 28002, 27956, 27909, 27861, 27812, 27762, 27711,
                     27658, 27604, 27549, 27493, 27436, 27378, 27319, 27259, 27197,
                     27134, 27070, 27005, 26939, 26871, 26802, 26732, 26661, 26589,
                     26515, 26440, 26364, 26286, 26207, 26127, 26045, 25962, 25878,
                     25792, 25705, 25617, 25527, 25436, 25344, 25250, 25155, 25058,
                     24960, 24861, 24760, 24658, 24554, 24449, 24342, 24234, 24125,
                     24014, 23902, 23788, 23673, 23556, 23438, 23319, 23198, 23076,
                     22952, 22827, 22700, 22572, 22443, 22312, 22180, 22047, 21912,
                     21776, 21639, 21500, 21360, 21219, 21077, 20933, 20788, 20642,
                     20495, 20347, 20197, 20046, 19894, 19741, 19587, 19432, 19276,
                     19119, 18962, 18804, 18645, 18485, 18324, 18163, 18001, 17838,
                     17675, 17511, 17346, 17181, 17015, 16849, 16683, 16516, 16349,
                     16182, 16015, 15847, 15679, 15511, 15343, 15175, 15007, 14839,
                     14672, 14505, 14338, 14171, 14005, 13839, 13673, 13508, 13343,
                     13179, 13015, 12852, 12689, 12518, 12339, 12152, 11959, 11760,
                     11557, 11350, 11140, 10927, 10713, 10498, 10282, 10066, 9851,
                     9637, 9424, 9213, 9004, 8797, 8593, 8392, 8194, 7999, 7808, 7620,
                     7436, 7256, 7080, 6907, 6738, 6573, 6412, 6255, 6102, 5952, 5806,
                     5664, 5525, 5390, 5258, 5129, 5004, 4882, 4763, 4647, 4534, 4424,
                     4317, 4213, 4111, 4012, 3915, 3821, 3729, 3639, 3552, 3467, 3384,
                     3303, 3224, 3147, 3072, 2998, 2926, 2856, 2788, 2722, 2657, 2594,
                     2532, 2472, 2413, 2356, 2300, 2245, 2192, 2140, 2089, 2040, 1992,
                     1945, 1899, 1854, 1810, 1767, 1725, 1684, 1644, 1605, 1567, 1530,
                     1494, 1458, 1424, 1390, 1357, 1325, 1294, 1263, 1233, 1204, 1175,
                     1147, 1120, 1093, 1067, 1042, 1017, 993, 970, 947, 924, 902,
                     881, 860, 840, 820, 800, 781, 762, 744, 727, 709, 692, 676, 660,
                     644, 629, 614, 599, 585, 571, 557, 544, 531, 518, 506, 494, 482,
                     470, 459, 448, 437, 427)
  expect_equal(sumB,sumB_compared)
})
