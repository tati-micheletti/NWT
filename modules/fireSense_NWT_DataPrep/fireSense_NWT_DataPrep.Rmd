---
title: "fireSense_NWT_DataPrep"
author: "Jean Marchal"
date: "January 31, 2019"
output: html_document
---

The purpose of this file is to prepare the climate and vegetation data needed to run the fireSense modules for the Northwest Territories.

# Setup
```{R global_options, echo=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

## Load the packages used by the script
```{r packages, message=FALSE}
library(dplyr)
library(raster)
library(reproducible)
library(sf)
library(sp)
library(tibble)
```

# Climate
## Create csv file with the lat, long, elevation needed by ClimateNA
```{R Prepare ClimateNA inputs}
#
# Latitude, longitude
#
## Load BCR6 (raster)
#
BCR6 <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1sEiXKnAOCi-f1BF7b4kTg-6zFlGr0YOH",
  targetFile = "bcr6.tif",
  useCache = TRUE
)

withinBCR6 <- !is.na(BCR6[])

#
# Elevation
#
## Load elevation data
#
DEM <- prepInputs(
  url = "https://drive.google.com/open?id=1WHZnpWokgjraR7tGz0mIJEr9klLGUzB0",
  targetFile = "nadem100laz.tif", # Be explicit and tractable
  overwrite = TRUE,
  useCache = TRUE
)

#
## Reproject, crop, mask the DEM
#
preCropInputs <- function(bcr6, dem)
{
  # Speed-up process by pre-cropping: 110% of the extent of BCR6
  e <- as(extent(bcr6) * 1.1, "SpatialPolygons")
  proj4string(e) <- proj4string(bcr6)
  e <- spTransform(e, CRSobj = proj4string(dem))
  cropInputs(x = dem, studyArea = e)
}

DEM <- Cache(
  postProcess,
  x = preCropInputs(BCR6, DEM),
  rasterToMatch = BCR6, 
  maskWithRTM = TRUE
)

#
## Extract elevation data
#
elev <- DEM[withinBCR6]


#
# Write lat, long, elev to csv
#
write.csv(
  (
    bind_cols(
      (
        st_as_sf(
          as_tibble(
            raster::xyFromCell(BCR6, which(withinBCR6)[!is.na(elev)])
          ),
          coords = c("x", "y"),
          crs = proj4string(DEM)
        ) %>%
          st_transform(crs = 4326) %>%
          st_coordinates() %>%
          as_tibble() %>%
          rename(lat = Y, long = X)
      ),
      tibble(el = elev[!is.na(elev)]) # Parts of the DEM where we have no data, 
                                      # after manual inspection, they are pixels
                                      # in the sea. Confirmed by Diana.
    ) %>%
      mutate(ID1 = which(withinBCR6)[!is.na(elev)], ID2 = "z") %>%
      dplyr::select(ID1, ID2, lat, long, el)    
  ),
  file = "climateNA_inputs.csv",
  row.names = FALSE
)

```


```{R Read climateNA ouputs}
# Load CSV files with monthly variables
```

# Vegetation
## Load LCC05, reproject, crop, etc...
```{r LCC05_GIS}
# Load BCR6 (raster)
BCR6 <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1sEiXKnAOCi-f1BF7b4kTg-6zFlGr0YOH",
  targetFile = "bcr6.tif",
  useCache = TRUE
)

LCC05 <- Cache(
  postProcess,
  x = prepInputs(
    url = "https://drive.google.com/open?id=1ziUPnFZMamA5Yi6Hhex9aZKerXLpVxvz",
    rasterToMatch = BCR6,
    targetFile = "LCC2005_V1_4a.tif",
    overwrite = TRUE,
    useCache = TRUE
  ),
  method = "ngb",
  rasterToMatch = BCR6,
  maskWithRTM = TRUE
)

LCC10 <- Cache(
  postProcess,
  x = prepInputs(
    rasterToMatch = BCR6,
    targetFile = "CAN_NALCMS_LC_30m_LAEA_mmu12_urb05_CAL.tif",
    destinationPath = "F:/NWT/Vegetation/",
    overwrite = TRUE,
    useCache = TRUE
  ),
  method = "ngb",
  rasterToMatch = BCR6,
  maskWithRTM = TRUE
)



```

## Reclassfiy LCC2005 (39 classes)

|Description|Code|
| ------------------------------------------- |-----:|
|Temperate or subpolar needle-leaved evergreen closed tree canopy|1|
|Cold deciduous closed tree canopy|2|
|Mixed needle-leaved evergreen – cold deciduous closed tree canopy|3|
|Mixed needle-leaved evergreen – cold deciduous closed young tree canopy|4|
|Mixed cold deciduous - needle-leaved evergreen closed tree canopy|5|
|Temperate or subpolar needle-leaved evergreen medium density, moss-shrub understory|6|
|Temperate or subpolar needle-leaved evergreen medium density, lichen-shrub understory|7|
|Temperate or subpolar needle-leaved evergreen low density, shrub-moss understory|8|
|Temperate or subpolar needle-leaved evergreen low density, lichen (rock) understory|9|
|Temperate or subpolar needle-leaved evergreen low density, poorly drained|10|
|Cold deciduous broad-leaved, low to medium density|11|
|Cold deciduous broad-leaved, medium density, young regenerating|12|
|Mixed needle-leaved evergreen - cold deciduous, low to medium density|13|
|Mixed cold deciduous - needle-leaved evergreen, low to medium density|14|
|Low regenerating young mixed cover|15|
|High-low shrub dominated|16|
|Grassland|17|
|Herb-shrub-bare cover|18|
|Wetlands|19|
|Sparse needle-leaved evergreen, herb-shrub cover|20|
|Polar grassland, herb-shrub|21|
|Shrub-herb-lichen-bare|22|
|Herb-shrub poorly drained|23|
|Lichen-shrub-herb-bare soil|24|
|Low vegetation cover|25|
|Cropland-woodland|26|
|High biomass cropland|27|
|Medium biomass cropland|28|
|Low biomass cropland|29|
|Lichen barren|30|
|Lichen-sedge-moss-low shrub wetland|31|
|Lichen-spruce bog|32|
|Rock outcrops|33|
|Recent burns|34|
|Old burns|35|
|Urban and Built-up|36|
|Water bodies|37|
|Mixes of water and land|38|
|Snow/ice|39|
\  

Reclassified as:

|Description|Code|
| -------------------------------- |-----:|
|Conifer|1|
|Crops|2|
|Deciduous|3|
|Disturbed|4|
|Mixed, conifer-dominated|5|
|Mixed, deciduous-dominated|6|
|Open|7|
|Open-conifer|8|
|Shrub|9|
|Wetlands|10|
|Water|NA|
\  
```{R Reclassify LCC05 39 classes}
rcl <- matrix(
  #   from,  to,    becomes
  c(     -1,  0.01,       2, # After visual inspection, likely croplands
       0.99,  1.01,       1,
       1.99,  2.01,       3,
       2.99,  3.01,       5,
       3.99,  5.01,       6,
       5.99, 10.01,       1,
      10.99, 12.01,       3,
      12.99, 13.01,       5,
      13.99, 14.01,       6,
      14.99, 15.01,       4,
      15.99, 16.01,       9,
      16.99, 17.01,       2,
      17.99, 18.01,       7,
      18.99, 19.01,      10, # Wetlands, waiting for Tati's update
      19.99, 20.01,       8,
      20.99, 24.01,       9,
      24.99, 25.01,       7,
      25.99, 29.01,       2,
      29.99, 31.01,       7,
      31.99, 32.01,      10, # Wetlands (here lichen-spruce bog), waiting for Tati's update
      32.99, 33.01,      NA,
      33.99, 35.01,       4,
      35.99, 39.01,      NA
  ),
  ncol = 3,
  byrow = TRUE
)
```


