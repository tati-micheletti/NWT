---
title: "runMe"
author: "Tati Micheletti"
date: "1/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SpaDES.core)
library(SpaDES.tools)

# Source all common functions
invisible(sapply(X = list.files(file.path(getwd(), "functions"), full.names = TRUE), FUN = source))
```

## Simulation of effects of climate change on fire regime: implications for Boreal Caribou and
landbird communities in the Northwest Territories

The proposed work integrates simulation models of vegetation dynamics and wildfire with 
statistical models of songbird abundances and woodland caribou demographic parameters. The
integrated model is used to forecast the spatial distribution of selected songbird species and
the regional potential to sustain viable populations of woodland caribou, under climate change
over the 21 st century. Other applications are quantifying the overlap
between areas of high conservation value for birds and for caribou, and evaluating the
conservation potential in these respects of specific candidate protected areas. The integrated
model is implemented as a suite of modules in SpaDES, a new R-based environment for
developing and running spatial simulations over large spatial extents. The spatial extent of this
work is BCR 6 as contained within the Northwest Territories of Canada. The spatial resolution of 
the vegetation dynamics and avian habitat forecasts is 250m.

### General objectives

Item #1: Species Abundance Models (SAMs) for landbirds under current conditions.
Item #2: Land change simulation (2000-2100)
Item #3 Demographic models for caribou, SAMs for landbirds, co-occurrence under future
conditions

### Integrated modules overview

The metamodule is composed of 8 parent modules (i.e. groups of modules), as follows:
![Module structure that composes the NWT project.](https://github.com/tati-micheletti/NWT/raw/master/data/ModelStructure_2.jpg)

The structure of each one of the modules is as follows:

\textcolor{blue}{LandR}: This group of modules is composed of one module and one group of modules. The first module, `Boreal_LBMRDataPrep` creates the specific parameters to be used on the specified study area (BRC6 within NWT). The group of modules (`LandR_Biomass`) is composed of (1) `LandR_BiomassGMOrig`: is responsible for growth and mortality, (2) `Biomass_regeneration`: does post-disturbance biomass regeneration for LandR, and (3) `LBMR`: this is the module in LandR that is responsible for the forest succession. LandR needs at least these last three modules to work.

\textcolor{blue}{birdsNWT}: To be completed later by TM.

\textcolor{blue}{caribou}: The `caribou` module is composed of two modules: `caribouRSF` and `caribouPopGrowth` (names to be fixed by FS) 

\textcolor{blue}{FireSense}: To be completed by JM.

\textcolor{blue}{anthropogenic}: To be completed by MT.

### Setting up directories and paths for the simulation

```{r setup}

# Which computer is this being run on?
whichComputer <- "388"
# Other options are: BorealCloud, LocalMachine

paths <- pathsSetup(whichComputer = whichComputer, setTmpFolder = TRUE) # If setTmpFolder == TRUE, 
 # a temporary folder will be created inside the cache folder set. This can/should be changed later for 
 # other projects using:
# ===> In Windows:
# write(TMPDIR = '<path/to/tempFolder>'), file = file.path(Sys.getenv('R_USER'), '.Renviron'))
# ===> In Linux/MacOS:
# tryCatch(library(unixtools),
#   error = function(e) install.packages("unixtools", repos = 'http://www.rforge.net/'))
#   unixtools::set.tempdir(<path/to/tempFolder>)

# Sessting up the cache folder: it is hosted in the project's GDrive
cloudFolderID <- "https://drive.google.com/open?id=1PoEkOkg_ixnAdDqqTQcun77nUvkEHDc0"

# Setting all SpaDES options to be used in the project
options("reproducible.useMemoise" = TRUE) # Brings cached stuff to memory during the second run
options("reproducible.cachePath" = paths$cachePath) # Set cachePath globally
options("reproducible.useNewDigestAlgorithm" = TRUE) # use the new less strict hashing algo
options("reproducible.useCloud" = TRUE) # use cloudCache in GDrive

SpaDES.core::setPaths(modulePath = paths$modulePath, inputPath = paths$inputPath, outputPath = paths$outputPath, cachePath = paths$cachePath)

```

### Creating study area
```{r studyArea}

# For NWT inside the boreal region:
studyArea <- Cache(defineStudyArea, testArea = TRUE, specificTestArea = "BCR6",
                   mapSubset = "Northwest Territories", destinationPath = tempdir(), overwrite = TRUE) %>%
  rgeos::gUnaryUnion()

# studyArea <- cloudCache(defineStudyArea, testArea = TRUE, specificTestArea = "BCR6", 
#                         mapSubset = "Northwest Territories", destinationFolder = paths$inputPath,
#                         useCloud = getOption("reproducible.useCloud", TRUE), 
#                         checksumsFileID = NULL, cloudFolderID = cloudFolderID)
```

### Running `LandR_Biomass`

```{r run_LandR, echo=TRUE}

# FROM HERE ON ......

library(SpaDES)
library(raster)

spadesModulesDirectory <- file.path("modules") # where modules are 
modules <- list("Boreal_LBMRDataPrep", "LBMR", "LandR_BiomassGMOrig","Biomass_regeneration", "group_scfm")
#, BiomassSpeciesData, #

times <- list(start = 0, end = 20)

#scfm global parameters
defaultInterval <- 1.0
defaultPlotInterval <- 1.0
defaultInitialSaveTime <- NA #don't be saving nuffink

# shpStudyRegionFull <- shapefile("C:/Ian/Tati/Edehzhie/Edehzhie_subset.shp")
ecoDistricts <- shapefile("C:/Ian/Git/scfm/modules/scfmLandcoverInit/data/ecodistricts_shp/Ecodistricts/ecodistricts.shp")
studyArea <- ecoDistricts[ecoDistricts$DISTRICT_I %in% c(387, 390, 372),] #3 small contiguous ecodistricts in the RIA
# studyArea$Name <- "District 387-390-372"
studyAreaLarge <- ecoDistricts[ecoDistricts$ECOREGION %in% c(137, 200),] #the two larger ecoregions

# rasterToMatch <- reproducible::Cache(pemisc::prepInputsLCC, 
#                        studyArea = studyArea, year = 2005, 
#                        filename2 = "rasterToMatch.tif", overwrite = TRUE)
rasterToMatch <- raster("rasterToMatch.tif") #debugging cache
studyArea <- spTransform(x = studyArea, CRSobj = crs(rasterToMatch))
studyAreaLarge <- spTransform(x = studyAreaLarge, CRSobj = crs(rasterToMatch))
parameters <- list(
  LBMR = list(.plotInitialTime = 0,
              seedingAlgorithm = "wardDispersal",
              useCache = TRUE,
              successionTimestep = 10), 
  LandR_BiomassGMOrig = list( # dev branch
    growthInitialTime = 0,
    successionTimestep = 10),
  # BiomassSpeciesData = list( #proprietary data
  #   .useCache = TRUE,
  #   omitNonTreePixels = FALSE),
  Boreal_LBMRDataPrep = list(
    successionTimeStep = 10
  ),
  Biomass_regeneration = list(),
  #SCFM MODULES
  ageModule = list(
    initialAge = 100,
    maxAge = 200,
    returnInterval = defaultInterval,
    startTime = times$start,
    .plotInitialTime =  NA,
    .plotInterval = defaultPlotInterval,
    .saveInitialTime = defaultInitialSaveTime,
    .saveInterval = defaultInterval),
  scfmIgnition = list(
    pIgnition = 0.0001,
    returnInterval = defaultInterval,
    startTime = times$start,
    .plotInitialTime = NA,
    .plotInterval = defaultPlotInterval,
    .saveInitialTime = defaultInitialSaveTime,
    .saveInterval = defaultInterval),
  scfmEscape = list(
    p0 = 0.05,
    returnInterval = defaultInterval,
    startTime = times$start,
    .plotInitialTime = NA,
    .plotInterval = defaultPlotInterval,
    .saveInitialTime = defaultInitialSaveTime,
    .saveInterval = defaultInterval),
  scfmSpread = list(
    pSpread = 0.235,
    returnInterval = defaultInterval,
    startTime = times$start,
    .plotInitialTime = times$start,
    .plotInterval = defaultPlotInterval,
    .saveInitialTime = defaultInitialSaveTime,
    .saveInterval = defaultInterval),
  scfmRegime = list(fireCause=c("L", "H"))
)

## Paths are not workign with multiple module paths yet
setPaths(cachePath =  file.path("cache2"),
         modulePath = c(spadesModulesDirectory, file.path("C:/Ian/Git/scfm/modules")),
         inputPath = file.path(getwd(), "inputs"),
         outputPath = file.path("outputs"))
paths <- SpaDES.core::getPaths()
#
options("spades.moduleCodeChecks" = FALSE)
# clearCache("cache2/")


#Tree species that are important to us
data("sppEquivalencies_CA", package = "LandR", envir = environment())
sppEquivalencies_CA
test <- sppEquivalencies_CA[LandR %in% c("Abie_sp", "Pice_gla", "Pice_mar", "Popu_tre",
                                         "Betu_pap", "Pinu_con", "Pinu_ban")]

objects <- list(
  studyArea = studyArea,
  rasterToMatch = rasterToMatch,
  sppEquiv = test,
  studyAreaLarge = studyAreaLarge
  )
#                 

#You have to supply all possible studyArea combinations here or the simInit will source the wrong things.
#This is a good argument for all modules only ever using studyArea. Never studyArea0 or SA or ROI
myObjectSynonyms <- list(c("LCC2005", "vegMap")) 

options(reproducible.overwrite = TRUE)
options(reproducible.cachePath = "C:/Ian/Campbell/RIA/cache2")#necessary for some reason
options(reproducible.inputPathsRecursive = "C:/Ian/Data")

mySim <- simInit(times = times, params = parameters, modules = modules, objects = objects,
                 paths = list(cachePath = paths$cachePath, modulePath = paths$modulePath, 
                              inputPath = paths$inputPath, outputPath = paths$outputPath),
                 loadOrder = unlist(modules))

dev.off()
dev() 
mySimOut <- spades(mySim, debug = TRUE)
```

