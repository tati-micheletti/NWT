---
title: "runMe"
author: "Tati Micheletti"
date: "1/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("SpaDES")
library("raster")
library("magrittr") # for piping

# Source all common functions
invisible(sapply(X = list.files(file.path(getwd(), "functions"), full.names = TRUE), FUN = source))
```

## Simulation of effects of climate change on fire regime: implications for Boreal Caribou and
landbird communities in the Northwest Territories

The proposed work integrates simulation models of vegetation dynamics and wildfire with 
statistical models of songbird abundances and woodland caribou demographic parameters. The
integrated model is used to forecast the spatial distribution of selected songbird species and
the regional potential to sustain viable populations of woodland caribou, under climate change
over the 21 st century. Other applications are quantifying the overlap
between areas of high conservation value for birds and for caribou, and evaluating the
conservation potential in these respects of specific candidate protected areas. The integrated
model is implemented as a suite of modules in SpaDES, a new R-based environment for
developing and running spatial simulations over large spatial extents. The spatial extent of this
work is BCR 6 as contained within the Northwest Territories of Canada. The spatial resolution of 
the vegetation dynamics and avian habitat forecasts is 250m.

### General objectives

Item #1: Species Abundance Models (SAMs) for landbirds under current conditions.
Item #2: Land change simulation (2000-2100)
Item #3 Demographic models for caribou, SAMs for landbirds, co-occurrence under future
conditions

### Integrated modules overview

The metamodule is composed of 8 parent modules (i.e. groups of modules), as follows:
![Module structure that composes the NWT project.](https://github.com/tati-micheletti/NWT/raw/master/inputs/ModelStructure_2.jpg)

The structure of each one of the modules is as follows:

\textcolor{blue}{LandR}: This group of modules is composed of one module and one group of modules. The first module, `Boreal_LBMRDataPrep` creates the specific parameters to be used on the specified study area (BRC6 within NWT). The group of modules (`LandR_Biomass`) is composed of (1) `LandR_BiomassGMOrig`: is responsible for growth and mortality, (2) `Biomass_regeneration`: does post-disturbance biomass regeneration for LandR, and (3) `LBMR`: this is the module in LandR that is responsible for the forest succession. LandR needs at least these last three modules to work.

\textcolor{blue}{birdsNWT}: To be completed later by TM.

\textcolor{blue}{caribou}: The `caribou` module is composed of two modules: `caribouRSF` and `caribouPopGrowth` (names to be fixed by FS) 

\textcolor{blue}{FireSense}: To be completed by JM.

\textcolor{blue}{anthropogenic}: To be completed by MT.

### Setting up directories and paths for the simulation

```{r setup}

# Which computer is this being run on?
# Options are: BorealCloud, LocalMachine, 388
whichComputer <- "388"

paths <- pathsSetup(whichComputer = whichComputer, setTmpFolder = TRUE) 
# If setTmpFolder == TRUE, a temporary folder will be created inside the cache folder set. 
# This can/should be changed later for other projects using:
# ===> In Windows:
# write(TMPDIR = '<path/to/tempFolder>'), file = file.path(Sys.getenv('R_USER'), '.Renviron'))
# ===> In Linux/MacOS:
# tryCatch(library(unixtools),
#   error = function(e) install.packages("unixtools", repos = 'http://www.rforge.net/'))
#   unixtools::set.tempdir(<path/to/tempFolder>)

# Sessting up the cache folder: it is hosted in the project's GDrive
cloudFolderID <- "https://drive.google.com/open?id=1PoEkOkg_ixnAdDqqTQcun77nUvkEHDc0"

# Setting all SpaDES options to be used in the project
options("reproducible.overwrite" = TRUE)
options("reproducible.useMemoise" = FALSE) # Brings cached stuff to memory during the second run
options("reproducible.cachePath" = paths$cachePath) # Set cachePath globally
options("reproducible.useNewDigestAlgorithm" = TRUE) # use the new less strict hashing algo
options("reproducible.useCloud" = TRUE) # use cloudCache in GDrive
options("spades.moduleCodeChecks" = FALSE) # Turn off all module's code checking

SpaDES.core::setPaths(modulePath = paths$modulePath, inputPath = paths$inputPath, 
                      outputPath = paths$outputPath, cachePath = paths$cachePath)

```

### Creating study area

The study area is comprised of the *BCR6* (Bird Conservation Regions no. 6) within the *Northwest Territories*.  
We have developed a specific function to select this area, which is cached both locally and remotely 
in a google drive's folder (`cloudFolderID`), which is sharable with all project's team members.

```{r studyArea}

studyArea <- cloudCache(defineStudyArea, testArea = TRUE, mapSubset = "Northwest Territories",
                        destinationPath = paths$inputPath, specificTestArea = "BCR6",
                        useCloud = TRUE, cloudFolderID = cloudFolderID) %>%  rgeos::gUnaryUnion()

```

### Running `LandR_Biomass`

To run the first set of modules, both the parametrization model (`Boreal_LBMRDataPrep`) and the forest succession group of modules (`LandR_Biomass`), 
we explicitly specify the modules to be run, and the running time for the simulations:

```{r run_LandR}

modules <- list("Boreal_LBMRDataPrep", "LandR_BiomassGMOrig","Biomass_regeneration", "LBMR")
times <- list(start = 0, end = 20)

```

Then we need to set the parameters for the simulation call:

``` {r params}

parameters <- list(
  LBMR = list(.plotInitialTime = 0,
              seedingAlgorithm = "wardDispersal",
              useCache = TRUE,
              successionTimestep = 10), 
  LandR_BiomassGMOrig = list( # dev branch
    growthInitialTime = 0,
    successionTimestep = 10),
  Boreal_LBMRDataPrep = list(
    successionTimeStep = 10
  )
)

```

Now we have to set the objects. The first object is a list of trees of interest:

~~~~ HERE: Make this as a nice table

``` {r objects}
# Tree species specified for the project (see "Meeting minute January 16th, 2019" from Google Drive)
# CommonName = scientificName = LandRName
# Jack pine = Pinus banksiana = Pinu_ban
# Black spruce = Picea mariana = Pice_mar
# White spruce = Picea glauca = Pice_gla
# Balsam poplar = Populus balsamifera = Popu_bal
# aspen = Populus tremuloides = Popu_tre, Popu_sp * Check this table with Steve
# Paper birch = Betula papyrifera = Betu_pap

# Equivalency table for tree species
data("sppEquivalencies_CA", package = "LandR", envir = environment())
print(sppEquivalencies_CA[,.(LandR, EN_generic_full, Latin_full)], nrow = nrow(sppEquivalencies_CA))

speciesNWT <- sppEquivalencies_CA[LandR %in% c("Pinu_ban", "Pice_mar", "Pice_gla", "Popu_bal",
                                         "Popu_tre", "Popu_sp", "Betu_pap")]
objects <- list(
  studyArea = studyArea,
  sppEquiv = speciesNWT
  )

```

After supplying the objects, we run the simulation initialization function, passing all arguments of interest:

``` {r simInit}

mySim <- simInit(times = times, params = parameters, modules = modules, objects = objects,
                 paths = paths, loadOrder = unlist(modules))

```

And finally the simulation call (note that the argument `debug = TRUE` lists all processes that are happening):

```{r call}

LandR_Biomass <- spades(mySim, debug = TRUE)

```

