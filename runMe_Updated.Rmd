---
title: "Simulting climate change and fire regime: implications for boreal caribou and landbird communities in the Northwest Territories"
subtitle: "From data to decisions in SpaDES: an integrated projection project for the Northwest Territories"
authors: "Tati Micheletti^1^, Frances Stewart^2^, Eliot McIntire^1,2^, Ian Eddy^2^,  Ceres Barros^1^, Jean Marchal^3^, 
Diana Stralberg^4^, Mario van Telgen^5^, Ana Raymundo^5^, Alex Chubaty^6^, Steve Cumming^5^"
affiliations: "^1^ University of British Columbia, ^2^ Natural Resources Canada, Canadian Forest Service, ^3^WavX Inc ,
^4^ University of Alberta, ^5^Universite Laval, ^6^ fRI"
date: "Draft last revised 3/31/2019"
 # html_document:
 #    keep_md: yes
 #    toc: yes
 #    toc_depth: 5
 # pdf_document:
 #    keep_md: yes
 #    toc: yes
 #    toc_depth: 5
---


# Executive Summary

The proposed work integrates simulation models of vegetation dynamics, wildfire, and anthropogenic change with 
statistical models of songbird abundances and woodland boreal caribou (*Rangifer tarandus caribou*) resouorce selection and demographic
parameters. The integrated model is used to forecast the spatial distribution of selected songbird species and the regional potential
to sustain viable populations of woodland boreal caribou, under climate change over the 21st century. Other potential applications
include quantifying the overlap between areas of high conservation value for birds and for caribou, and evaluating the conservation
potential inthese respects of specific candidate protected areas. The integrated model is implemented as a suite of eight modules in
SpaDES (Chubaty and McIntire 2017), a cutting-edge R-based environment for developing and running spatial simulations over large
spatial extents. The spatial extent of this work is Bird Conservation Region (BCR) 6 as contained within the Northwest Territories of
Canada. All modules in this project output 250m resolution layers, and all LandR, bird, and caribou modules mask all landscape features
that are not forested from their analyses; their outputs are based on forested landclasses (see the `LandR` module description below).

This project represents the cummulation of a novel integration method for discrete event simulations. To our knowledge it is the
largest and most comprehensive integration of landscape and climate change effects on Species At Risk todate. It represents a novel and
important contribution to ecological forecasting, and contains the ability to uniquely address both national (i.e. *Species At Risk
Act*) and international (i.e. *Convention on Biological Diversity Aichi Target 11*) policy mandates for biodiversity conservation
today, and under anticipated future conditions.

The models contained within this project represent regional processes and do not reflect projected landscape specific results. The
results from this project are to be used for regional planning initiatives and are built off of known ecological processes and
statistical relationships documented at regional and national scales. These processes may not acurately predict localized processes -
this discrepency between scales is well documented in ecology (Wiens 1989; Holling 1992; Levin 1992; Burton et al. in review) with
direct ramifications on downscaling models (e.g. Riiters 2005; Araujo et al. 2005). Future iterations of this project may be able to
address these scale-specific processes, but the models provided here will best provide results for planning at large spatial extents
(by region or ecozone, not landscape). 


## General project components as stated in the RFP

Item #1: Species Abundance Models (SAMs) for landbirds under current conditions.
Item #2: Land change simulation (2000-2100).
Item #3: Demographic models for caribou, SAMs for landbirds, co-occurrence under future conditions. 


# Integrated modules overview: Items 1, 2, and components of item 3

The metamodule is composed of 8 parent modules (i.e. groups of modules), as follows:
![Figure 1. Module structure that composes the NWT project]
(https://github.com/tatimicheletti/NWT/raw/master/inputs/ModelStructure_2.jpg)

<!-- TATI TO DOUBLE CHECK AND FINALIZE -->
Running the entire project for a 100 year simulation can take several days on a 1 TB, 50 core RAM Linux computer.

module                | approximate duration |
:--------------------:|:--------------------:|
LandR                 |  3.05 days           |
fireSense             |                      | 
FEENIX                |                      |
anthropogenic         |                      |
BirdsNWT              |  0.13 days           |
caribouRSFModel       |  1.40 days           |
caribouPopGrowthModel |  0.04 days           |
TOTAL                 |  5.70 days           |

The structure and methods used for each one of the modules is as follows:


\textcolor{blue}{LandR}: `LandR` is a landscape dynamic vegetation model; it simulates landscape-scale forest dynamics in a spatio
                          temporally explicit manner. The `LandR` group of modules is composed of one data treatment and
                          parameterisation module, and a group of modules that simulate biomass succession dynamics. 

The first module, `Boreal_LBMRDataPrep` calculates site-specific parameters needed by the biomass succession modules - for this project
these site specific parameters are estimated for Bird Conservation Region (BCR) 6 within the Northwest Territories. For instance,
maximum biomass, above-ground net primary productiviey (aNPP), and establishment probabilities from seed germination are calculated
separately depending on tree species cover and biomass, ecodistrict, land cover class (from the Land Cover Map of Canada 2005;
LCC2005), and stand age. This module also provides other parameters, such as species tolerances to shade, and other plant traits (e.g.
longevity, ability to resprout, etc.). These traits were obtained from trait tables used in LANDIS-II, a popular forest-landscape
simulation model, and are available from Dominic Cyr's GitHub page: 
(https://raw.githubusercontent.com/dcyr/LANDIS-II_IA_generalUseFiles/master/speciesTraits.csv)

The group of modules, named `LandR_Biomass` form the core of the vegetation succession model. These modules were inspired by the
LANDIS-II Biomass Success module (v6.2), but have since been changed (*i.e.* spin-up was removed and some algorithms were improved;
Barros et al. in prep). They consist of (1) `LBMR`, the `LandR` module responsible for vegetation aging, dispersal, updating biomass
folowing other modules' events, and producing summary figures and tables; (2) `LandR_BiomassGMOrig`, the `LandR` module responsible for
cohort growth and mortality; and (3) `Biomass_regeneration`, the `LandR` module which handles post-disturbance biomass regeneration
(e.g. fire). `LandR` needs at least the first two modules (`LBMR` and `LandR_BiomassGMOrig`) to produce sensible vegetation dynamics.

In brief, the `LandR` modules simulate
biomass changes by cohort (species-age combinations) as a function of age, between-cohort competition for light resources, seed
dispersal and germination, regeneration following a disturbance, and background or fire-related mortality.

*Current limitations of the `LandR` module*
One of the greatest advantages of using `Boreal_LBMRDataPrep` is that parameters used for the vegetation succession modules can be
directly estimated from data. This is done “automatically” should the data or study area change. As with any model, this means that
model predictions need to be calibrated every time the study area changes. At the moment, none of the modules within the `LandR` group
automatically calibrate themselves. We have identified some limitations arising from this:

1. *Initial decrease in biomass in forested pixels*. Initial decreases in biomass during the first decades of the simulation are most
likely due to starting ages (![Canada national stand age map](http://tree.pfc.forestry.ca/kNN-StructureStandVolume.tar)) being too
close to species’ longevity parameters (from LANDIS-II Biomass Succession v6.2 traits table). This results in many cohorts either dying
immediately, or almost immediately, at the beginning of the simulation leading to a decrease in total biomass. Stand age maps and tree
longevity are known to be flawed. On the one hand, estimating stand age can be tricky and often relies on allometric
relationships which can vary immensely across environmental gradients. On the other hand, tree longevity is frequently estimated from
the average maximum “observed” ages (i.e. realized age) for a given species; observed age is greatly dependent on the environment and
disturbance conditions to which populations are exposed, rather than the potential maximum age of a tree under favourable conditions.
There isnt a clear answer as to what is the best way of dealing with these issues, but see below for some potential suggestions.

2. Because the `LandR` model is suited for forest dynamics, pixeLs that correspond to non-forested LCC2005 classes were not used to
report results presented here, although they were allowed to be in the simulation for fire spread.


Future versions of the `LandR` module group could include:
1. A spin-up similar to LANDIS-II (simulating cohort growth from time 0, minus stand age) to address the potential maximum tree age and
biomass conditions. This also comes with its own set of problems, as only even-aged stands (single cohorts) can be generated in this
way and biomasses will still need to be adjusted at the end of the spin-up so that they match more closely the observed biomass. This
can be especially tricky in cases where the current biomass was measured in forests with complex age structure and species admixture.
An alternate solution may be to let the model run for a few hundred timesteps (*i.e.* a stabilization phase) until vegetation dynamics
reach quasi-equilibrium, before introducing the subsequent modules within this project that rely on results from `LandR` (*i.e.*
`birdsNWT`, `caribouRSFModel`, and `caribouPopGrowthModel`). These solutions would address current `LandR` limitation #1.

2. Models such as `LandR` will often overestimate tree cover and biomass in open habitats because they lack quantified ecological
mechanisms that limit tree growth in these areas (*i.e.* differences in growing season length, soil nutrient and water availability, or
herbivory). Future versions of the `LandR` modules could either ignore this limitation and restrict simulation dynamics to currently
forested pixels, or incorporate estimates for these mechanisms allowing  `LandR` to predict for areas that do not correspond to purely
forested areas. This change would address current `LandR` limitation #2.

## STEVE TO PROVIDE FINAL COMMENTS ON HOW FEENIX-FIRESENSE INCORPORATES BOTH FIRESENSE AND SCFM TOGETHER ##
## THE BELOW IS JEAN'S FIRE SENSE TEXT. IAN AND ALEX HAVE PROVIDED TEXT ON SCFM IN ANOTHER DOCUMENT ##
\textcolor{blue}{fireSense}: `fireSense` is a landscape fire simulation module that is sensitive to both climate and vegetation change;
                              it reproduces the spatial and temporal variation of both the number of fires, and fire escape
                              probability. `fireSense` is composed of two groups of modules; a group that prepares and formats the data
                              (`climate_NWT_DataPrep`, `fireSense_NWT_DataPrep`, `LBMR2LCC_DataPrep`, and `MDC_NWT_DataPrep`), and a
                              group that implements the algorithms needed to simulate fire (`fireSense_FrequencyFit`,
                              `fireSense_FrequencyPredict`, `fireSense_EscapeFit`, and `fireSense_EscapePredict`).

Briefly, the `fireSense` data preparation modules consist of:
`climate_NWT_DataPrep` downloads climate data from the AdaptWest project, performs GIS operations on climate layers and makes them
available to other modules.

`MDC_NWT_DataPrep` computes the Monthly Drought Code from climate data following equations in Bergeron et al. (2010) and makes the
resulting layer available to other modules.

`fireSense_NWT_DataPrep` performs GIS operations on fire and vegetation data, as well as a number of operations to prepare the data for
analysis/prediction and makes the resulting datasets available to other modules.

`LBMR2LCC_DataPrep` translates `LandR_Biomass` outputs into seven of the nine land cover classes as needed by `fireSense` (Table 1);
the other two classes are the "non-fuel" class, which is ssumed to be static in time, and the "recently disturbed" class which is not
based on biomass but on age. Pixels are considered disturbed if the time since last disturbance is less than 16 years. This module
relies on a classifier built within the XGBoost library (Chen and Guestrin 2016) for the translation. Table 2 summarises the accuracy
per land cover class for the validation dataset.

![Table 1. Correspondence between the land cover classes used by `fireSense` and code from the Land Cover Map of Canada 2005]
|Land cover class           | Land cover map of Canada 2005 original code(s)             |
|:-------------------------:|:-----------------------------------------------------------|
|Conifer medium-density     | 7                                                          |
|Herbs and shrubs           | 16, 17, 18, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32 |
|Mixedwood conifer-dominated| 13                                                         |
|Non-fuel                   | 33, 36, 37, 38, 39                                         |
|Open conifer               | 20                                                         |
|Other conifer              | 1, 6, 8, 9, 10                                             |
|Other treed                | 2, 3, 4, 5, 11, 12, 14, 15                                 |
|Recently disturbed         | 34, 35                                                     |
|Wetlands                   | 19                                                         |

![Table 2. Classifier accuracy per landcover class on the validation dataset]
|Land cover class           | Accuracy|
|:-------------------------:|:--------|
|Conifer medium-density     | 0.68    |
|Herbs and shrubs           | 0.79    |
|Mixedwood conifer-dominated| 0.72    |
|Open conifer               | 0.70    |
|Other conifer              | 0.57    |
|Other treed                | 0.79    |
|Wetlands                   | 0.82    |


Briefly, the `fireSense` simulation modules consist of:
`fireSense_FrequencyFit` is an implementation of the method described in Marchal et al. (2017); it fits a statistical model used to
parameterize the fire ignition component of `fireSense`. Marchal et al. (2017) introduced climate sensitivity using the Monthly Drought
Code (MDC) of July and introduced vegetation sensitivity using five vegetation classes. In this project, we use the MDC of June along
with nine vegetation classes, all of which are derived from the 39 classes of LCC2005 (Table 1). We did not estimate the fire frequency
for the "non-fuel" class as it will not burn - it therefore remains as 0. This module outputs a fitted model object of class
`fireSense_FrequencyFit`.

`fireSense_FrequencyPredict` uses the model object provided by `fireSense_FrequencyFit` to predict fire frequency, or rates of fire
counts. The output of this module is a probability surface describing the expected fire frequency at a 250 m resolution. This
probability surface is updated annually, and used to feed the ignition component of `fireSense`.

`fireSense_EscapeFit` fits a statistical model used to parameterize the fire escape component of `fireSense`; a fire escapes when it
propagates outside the pixel in which it started. We used logistic regression to introduce climate and vegetation sensitivity to the
fire escape component. We expressed the probability that a fire escapes as a function of the Monthly Drought Code of June, and the nine
classes of land cover (Table 1). This module outputs a fitted glm model object.

`fireSense_EscapePredict` predicts fire frequency, or rates of fire counts, using the model object provided by `fireSense_EscapeFit`.
The output of this module is a probability surface describing the expected probability of fire escape at a 250 m resolution. This
probability surface is updated annually and used to feed the escape component of `fireSense`.

`fireSense` uses the probability surface predicted by `fireSense_FrequencyPredict` to determine where to start fires. At the spatial
and temporal scale used in this study, the probability of two or more fires per year is negligible, thus one may use the Bernoulli
approximation, as in Armstrong and Cumming (2003). From those fires that started, `fireSense` determines which fires escape.
`fireSense` then passes the information on pixels that are burning to `scfmSpread` (see below), which spreads the fires.

*Assumptions of the `fireSense` module*
1. The number of fires per 6.25ha of each land class is has a negative binomial distribution. We also assume that the fire intensity
may vary among land class types

2. The rate of fire detection is constant.

3. The statistical relationship between fire, weather, vegetation, and fire activity will remain constant through time.

4. The land cover class “non-fuels” is static throughout the simulation period. It corresponds to rock outcrops, urban areas, water
bodies and lands permanently covered with ice/snow


## MARIO TO ADD INFORMATION TO THIS ##
\textcolor{blue}{anthropogenic}: To be completed by MT.
IMPORTANT ASSUMPTION TO ADD: This module does not model seismic lines - see caveate for `caribouPopGrowthModel`
ASSUMPTION: no success with anthropogenic disturbance
Explains both road density layer and buffered 500m layer.


\textcolor{blue}{birdsNWT}: The birds module projects species abundance of bird species under forecasted landscape and climate
                            conditions. This module loads an existing glm model object for each species, located in  
                            (https://drive.google.com/open?id=1obSvU4ml8xa8WMQhQprd6heRrN47buvI).

The `birdsNWT` module develops boosted regression tree (BRT) models from avian point-count data and associated covariates using the
gbm.step function in the ‘dismo’ package (Hijmans et al. 2011) with a Poisson distribution and 10-fold cross-validation. BRT settings
are as recommended by Elith et al. (2008) and are consistent with Stralberg et al. (2015). The module includes a ‘brtplot’ function
that, for a given BRT model object, summarizes cross-validation statistics and variable importance (csv output), generates partial
dependence plots (pdf output), generates spatial predictions from input data layers (geotiff format), and generates maps of spatial
predictions (png format). The ‘cvsum’ function summarizes cross-validation statistics across species.

Avian data for Bird Conseravation Region (BCR) 6 were extracted from the Boreal Avian Modelling project avian dataset (Cumming et al.
2010, Barker et al. 2015) and supplemented with data from automated recording units (ARU) collected by Environment and Climate Change
Canada (Haché et al. unpublished data) and the University of Alberta Bioacoustic Unit (Bayne et al. unpublished data). Density offsets
were calculated according to methods described in Sólymos et al. (2013), and were based on the assumption that ARU data detectability
is similar to detectability by human observers (Yip et al. 2017).

Bird models were based on a restricted set of covariates that were either (a) assumed static over time or (b) direct outputs of the
`LandR` biomass module. We intentionally excluded climate covariates that also drive changes in vegetation and fire, given the assumed
lag in vegetation response to climate, and associated statistical decoupling of these covariates over time (Figure 1).

Model covariates assumed static through simulation periods included the following landcover covariates derived from  the Comission for
Environmental Cooperation (CEC) North American Landcover 2005:

WAT = water (1/0) 
URBAG = urban/agriculture (1/0)
LED25 = water proportion within 5x5 moving window (continuous) 
DEV25 = development proportion within 5x5 moving window (continuous)

We also included a categorical landform covariate derived from AdaptWest’s land facet layer (Michalak et al. 2015), with the following
class definitions:

1    Valley
2    Hilltop in Valley
3    Headwaters
4    Ridges and Peaks
5    Plains
6    Local Ridge in Plain
7    Local Valley in Plain
8    Gentle Slopes
9    Steep Slopes

Model covariates allowed to vary according to simulation outputs were tree species biomass estimates (g/m2) derived from Beaudoin et
al.’s (2017) predicted biomass layers for 2001 or 2011, depending on the date of survey (pre-2006 was associated with 2001 vegetation;
2006 and later was associated with 2011 vegetation). Biomass covariates for the following speices were included:

*Abies balsamea, Betula papyrifera, Larix laricina, Picea glauca, Picea mariana, Pinus banksiana, Pinus contorta, Populus balsamifera,
Populus tremuloides*

Models were developed for 71 passerine and near-passerine species that a) currently breed either in the Northwest Territories or
Alberta portions of BCR 6, b) for which density offsets were available, and c) for which data were sufficient to fit cross-validated
BRTs (see list below, in taxonomic order). For this project simulations were generated for 10 species, including:

SWTH    Swainson's Thrush (*Catharus ustulatus*) 
OVEN    Ovenbird (*Seiurus aurocapilla*)
AMRE    American Redstart (*Setophaga ruticilla*)
BLPW    Blackpoll Warbler (*Setophaga striata*) 
PAWA    Palm Warbler (*Setophaga palmarum*)
CAWA    Canada Warbler (*Cardellina canadensis*)
FOSP    Fox Sparrow (*Passerella iliaca*) 
WCSP    White-crowned Sparrow (*Zonotrichia leucophrys*)
RUBL    Rusty Blackbird (*Euphagus carolinus*)
RCKI    Ruby-crowned Kinglet (*Regulus calendula*) 


*Important assumptions of the `birdsNWT` module*
1. Density offsets assume that ARU data detectability is similar to detectability by human observers (sensu Yip et al. 2017).

2. We assume a lag in vegetation response to climate and therefore do not include climate covariates within this module that drive
changes in vegetation and fire.

3. The relative abundance of bird species is based an environmental niche modeling approach with associated assumptions (Wiens et al.
2009)

Future versions of the `birdsNWT` module could include:
1. Simulation for the remaining 61 species of passerine and near-passerine birds that breed either in the NWT or Alberta portions of
BCR6. A full list of 71 possible species include:

Alder Flycatcher (*Empidonax alnorum*), American Crow (*Corvus brachyrhynchos*), American Goldfinch (*Spinus tristis*), American Pipit
(*Anthus rubescens), American Redstart (*Setophaga ruticilla*), American Robin (*Turdus migratorius*), American Tree Sparrow
(*Spizella arborea*), Black-and-white Warbler (*Mniotilta varia*), Bay-breasted Warbler (*Setophaga castanea*), Black-backed Woodpecker
(*Picoides arcticus*), Black-capped Chickadee (*Poecile atricapillus*), Brown-headed Cowbird (*Molothrus ater*), Blue-headed Vireo
(*Vireo solitarius*), Blackburnian Warbler (*Setophaga fusca*), Blue Jay (*Cyanocitta cristata*), Blackpoll Warbler (*Setophaga
striata*), Boreal Chickadee (*Poecile hudsonicus*), Brewer’s Blackbird (*Euphagus cyanocephalus*), Brown Creeper (*Certhia americana*),
Brown Thrasher (*Toxostoma rufum*), Black throated Green Warbler (*Setophaga virens*), Canada Warbler (*Cardellina canadensis*), Clay
colored Sparrow (*Spizella pallida*), Cedar Waxwing (*Bombycilla cedrorum*), Chipping Sparrow (*Spizella passerina*), Cape May Warbler
(*Setophaga tigrina*), Common Grackle (*Quiscalus quiscula*), Connecticut Warbler (*Oporornis agilis*), Common Raven (*Corvus corax*),
Common Redpoll (*Acanthis flammea*), Common Yellowthroat (*Geothlypis trichas*), Chestnut-sided Warbler (*Setophaga pensylvanica*),
Dark-eyed Junco (*Junco hyemalis*), Eastern Kingbird (*Tyrannus tyrannus*), Eastern Phoebe (*Sayornis phoebe*), Evening Grosbeak
(*Coccothraustes vespertinus*), Fox Sparrow (*Passerella iliaca*), Golden crowned Kinglet (*Regulus satrapa*), Gray-cheeked Thrush
(*Catharus minimus*), Gray Jay (*Perisoreus canadensis*), Gray Catbird (*Dumetella carolinensis*), Hammond's Flycatcher (*Empidonax
hammondii*), Hermit Thrush (*Catharus guttatus*), Horned Lark (*Eremophila alpestris*) , House Wren (*Troglodytes aedon*), Le Conte's
Sparrow (*Ammodramus leconteii*), Least Flycatcher (*Empidonax minimus*), Lincoln's Sparrow (*Melospiza lincolnii*), Magnolia Warbler
(*Setophaga magnolia*), Mourning Warbler (*Geothlypis philadelphia*), Nashville Warbler (*Oreothlypis ruficapilla*), Northern
Waterthrush (*Parkesia noveboracensis*), Orange-crowned Warbler (*Oreothlypis celata*), Olive-sided Flycatcher (*Contopus cooperi*),
Ovenbird (*Seiurus aurocapilla*), Palm Warbler (*Setophaga palmarum*), Philadelphia Vireo (*Vireo philadelphicus*), Pine Grosbeak
(*Pinicola enucleator*), Pine Siskin (*Spinus pinus*), Pileated Woodpecker (*Dryocopus pileatus*), Purple Finch (*Haemorhous
purpureus*), Rose-breasted Grosbeak (*Pheucticus ludovicianus*), Red-breasted Nuthatch (*Sitta canadensis*), Ruby-crowned Kinglet
(*Regulus calendula*), Red-eyed Vireo (*Vireo olivaceus*), Ruffed Grouse (*Bonasa umbellus*), Rusty Blackbird (*Euphagus carolinus*),
Red-winged Blackbird (*Agelaius phoeniceus*), Savannah Sparrow (*Passerculus sandwichensis*), Sedge Wren (*Cisthothorus platensis*),
Song Sparrow (*Melospiza melodia*), Swamp Sparrow (*Melospiza georgiana*), Swainson's Thrush (*Catharus ustulatus*), Tennessee Warbler
(*Oreothlypis peregrina*), Townsend's Warbler (*Setophaga townsendi*), Tree Swallow (*Tachycineta bicolor*), Varied Thrush (*Ixoreus
naevius*), Veery (*Catharus fuscescens*), Vesper Sparrow (*Pooecetes gramineus*), Warbling Vireo (*Vireo gilvus*), White-breasted
Nuthatch (*Sitta carolinensis*), White-crowned Sparrow (*Zonotrichia leucophrys*), Western Tanager (*Piranga ludoviciana*), Western
Wood-Pewee (*Contopus sordidulus*), Wilson's Warbler (*Cardellina pusilla*), Winter Wren (*Troglodytes hiemalis*), White-throated
Sparrow (*Zonotrichia albicollis*), White-winged Crossbill (*Loxia leucoptera*), Yellow-bellied Sapsucker (*Sphyrapicus varius*),
Yellow-bellied Flycatcher (*Empidonax flaviventris*), Yellow-rumped Warbler (*Setophaga coronata*), Yellow Warbler (*Setophaga
petechia*) 

 
 
\textcolor{blue}{caribou}: The `caribou` module is composed of two main modules:  `caribouRSFModel` and `caribouPopGrowthModel`. Each
                           module loads existing glms developped by Environment Canada 2011 to project caribou occurrence and
                           demographics over 100 years as the anthropogenic (`anthropogenic` module), fire (`FireSense` module), and
                           natural features (`LandR` module) of the NWT BCR6 region (i.e. Taiga plains) changes. Combined, these
                           modules incorporate existing statistical relationships, with simulated landscape predictions, to produce the
                           probability of occurrence, and population growth rate, of Woodland caribou (boreal population) within the
                           NWT. 

`caribouRSFModel`
The statistical relationship between caribou telemetry collars and the landscape has been summarized within the Environment Canada 2011
Scientific Report as a resource selection function (sensu Manly et al. 2002). This module is based off of the top Taiga Plains ecozone
resource selection function (Environment Canada 2011; Table 46), generated from data collected from 24 Alberta, 50 British Columbia,
and 169 NWT collared adult female caribou between 2000 and 2010 (Environment Canada 2011; Table 39).

In the Taiga Plains ecozone, the relative probability of adult female boreal caribou resource selection (0 to 1) is best described by
(Environment Canada 2011; Table 46):

$Relative habitat selection  ~ Elevation + Elevation^2 + Vrug + Vrug^2 + RoadDensity + Deciduous + Shrub +                 Eq 1.
                                                   Herb + Water + RecentBurn + OldBurn$

The definition, and units of measurement, for each of the predictor variables in this relationship can be found in Environment Canada
2011 Table 40. The methods behind model development can be found throughout Environment Canada 2011 Appendix 7.3. 

Model covariates were assumed to either be static, or were obtained from other modules within this project:
1  Elevation (static; AdaptWest)
2  Vrug (static; adapted from AdaptWest sensu Sappington et al. 2007)
3  RoadDensity (static; `anthropogenic`)
4  Deciduous (dynamic; `LandR`)
5  Shrub (static; LCC05)
6  Herb (static; LCC05)
7  Water (static; LCC05)
8  RecentBurn (dynamic;  `FireSense`)
9  OldBurn (dynamic; `FireSense`)

This module determines the relative habitat selection of caribou based on each of the above habitats on a yearly time step. This
module produces a rasterized map of this relative selection across the NT1 Boreal Caribou Range (i.e. BCR6 within the NWT) for every 10
years of the simulation. Options include outputting maps for range planning regions outlined in either Figure 2 and/or Figure 3.

*Important assumptions of the `caribouRSFModel` module*
1 .Caribou are distributed in an ideal free distribution across the Taiga plains (Fretwell and Lucas 1970).

2. Resource selection leads to increased population fitness and population density (Manly et al. 2002). The resource selection
documented here is a relative probability, rather than true probability, as we used a use-available design (Manly et al. 2002).

3. The Taiga ecozone RSF model developed by Environment Canada 2011 reliably predicts the relative probability of occurrence for
woodland boreal caribou. See section 6.2.4 of Environment Canada 2011 for reasons this assumption may be violated.

4. Shrub and Herbacious landcover remains constant across the simulation period (2010 to 2110) despite the impacts of fire, succession,
or other landscape change processes.

5. Caribou VHF collar data is not biased - caribou were randomly, and opportunistically, collared. Caribou were not collared for
monitoring impacts of natural resource development projects, or other motives.

6. Caribou do not display season-specific habitat selection; the RSF model used here is based off of annual caribou ccurrences. It does
not account for seasonal variations.

7. OldBurns are considered to be anything older than 40 years. We assume that OldBurns are between 41 and 93 years old, as this would
have been the maximum time since fire that was quantifiable in Environment Canada 2011 (Appendix 7.3, section 5.3;1917 to 2010). 


Future versions of the `caribouRSFModel` module could incorporate;
1. Incorporation of the national realized caribou RSF model (Environment Canada 2011; Table 43) which has higher predictive capacity
than the Taiga Plains RSF modeled here. 

2. Future model outputs could be based off of the regional planning units specified in:
![Figure 2. Boreal caribou NT1 range planning regions 2018]
(https://github.com/tatimicheletti/NWT/blob/master/Boreal_caribou_NT1_range_planning_regions_2018.jpg)
![Figure 3. Units for ECCC modeling project 2019]
(https://github.com/tati-micheletti/NWT/blob/master/Units_for_ECCC_modeling_project_2019.jpg)
The outputs could involve both relative selection, and uncertainty of the relative selection (i.e. standard deviation of the mean
relative selection at each pixel) maps.


`caribouPopGrowthModel`
The `caribouPopGrowthModel` module builds upon the statistical relationship underpinning today’s national boreal caribou recovery
strategy (Environment Canada 2011; 2012). The module recalculates the response variable of this relationship (caribou calf recruitment)
on  a yearly time interval, and uses these data to determine the population growth rate, lambda (λ). 

Specifically, boreal caribou recruitment (Rec) - the proportion of caribou cows:calves at winter survey periods - is best predicted by
the total disturbance within a caribou study area (Environment Canada 2011; Table 55, model M3): 

                                          $Rec ~ total disturbance$                                     Eq 2.

The methods behind Eq 2. development can be read in Environment Canada 2011 (Appendix 7.6). The total disturbance within a study area
is described as the “percent total non-overlapping fire and anthropogenic disturbance (500 m buffer on anthropogenic; reservoirs
removed)" (Environment Canada 2011, Table 54). Fire is measured as “percent fire > 40 years old” within a caribou study area and
anthropogenic is measured as “percent non-overlapping anthropogenic disturbance (500 m buffer)” within a caribou study area
(Environment Canada 2011; Table 52). This module uses the rasterized output maps of both the `FireSense` (climate sensitive), and
`anthropogenic` module. These map the presence/absence of fire < 40 years old, or anthropogenic disturbances, at each 250 m x 250m
pixels. These rasterized maps were over-layed, were used to calculate the percent non-overlapping total disturbance within a caribou
study area for each time step, and are used as inputs for this statistical relationship (Eq 2.).

This module projects Eq 2 based off the the coefficients provided in (Environment Canada 2011; Table 56, model M3).

This module uses annually calculated recruitment values to determine the caribou  population growth rate - the proportional change in
population size (lambda; λ) - for each polygon in [Figure 2] and [Figure 3]. The population model used to estimate lambda on a yearly
time interval is well published for both caribou and other ungulates (Hatter and Bergerud 1991; McLoughlin et al. 2003; Sorensen et al.
2006; Hervieux et al. 2014):

                                            $λ = (1 - M)/(1 - Rec)$                 Eq 3.

Where recruitment (Rec) only involves juvenile female caribou (and assumes a 50:50 sex ratio), and adult female mortality
(M) is calculated as 1 - adult female survival (SadF). At each yearly time step λ is saved. This module outputs a plot of lambda, for
each requested region or caribou planning area [Figure 2], [Figure 3], over the simulated time interval (100 years; 2010 through 2110).
Please see the below assumptions for important information regarding these output plots.

*Important assumptions of the `caribouPopGrowthModel` module*
1. The statistical relationship between recruitment and the landscape described by Environment Canada is the correct
relationship for all Northwest Territories boreal caribou local population units. (Model M3, EC 2011 Table 56). This
relationship was determined from 24 boreal caribou study areas across Canada (N = 24), and lacks information on study areas
primarily driven by fire (EC 2011, Figure 67).

2. Adult female survival is constant. We used the Environment Canada 2011 recommended value of 0.85. We assume that this
value applies to all populations of boreal woodland caribou in the Northwest Territories, and that it does not vary across
the projected time of these modules.

3. We assume that caribou are homogeneously distributed throughout the requested regions and caribou planning areas of the
NWT (i.e. the ‘Proposed caribou Range Planning Regions’ and requested ‘Units for ECCC modeling projects’).

4. We assume that caribou do not move between the requested regions and planning areas of the NWT (i.e. the ‘Proposed caribou
Range Planning Regions’ and requested ‘Units for ECCC modeling projects’); we assume these areas are functionally isolated
from one another.


Future versions of the `caribouPopGrowthModel` module could address many of the above assumptions. An updated module could
incorporate;
1. Incorporation of seismic lines as part of the `anthropogenic` module to ensure that the effect of future seismic lines
affects caribou recruitment, as assumed in Environment Canada 2011.

2. Revised caribou study areas (or local population units - the recommended scale of population management; Environment
Canada 2012), demographic values, and/or statistical models to incorporate contemporary data under updated data sharing
agreements.

3a. Flexibility to test multiple top statistical models presented in Environment Canada 2011 ( i.e. rather than solely Eq 3.; Table 55,
Table 56) or future reports.

3b. The output of the `caribouRSFModel` as a predictor in the `caribouPopGrowthModel` statistical model. This would explicitly
link these two modules by using high quality habitat as a predictor of caribou recruitment  (sensu Environment Canada 2011,
Table 55, model M12).

4. A statistical relationship between recruitment and landscape change that is specific to the NWT (addressing assumption #
1 above).

5. A statistical relationship between adult female survival and landscape change that is specific to the NWT (addressing
assumption # 2 above).

7. Incorporation of a caribou population model that is both logistic (i.e. density dependent) and/ or stochastic to look at
projected variations in population size. 

# SpaDES R code for module integration
## Update and/or install all needed packages

If you don't have all packages installed yet, please 
first update all your packages and then install SpaDES. 
Make sure you restart your session after installing all packages.

```{r github, include=FALSE, eval = FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = FALSE)

update.packages(checkBuilt = TRUE)
devtools::install_github("PredictiveEcology/reproducible@development")
devtools::install_github("achubaty/amc@development")
devtools::install_github("PredictiveEcology/pemisc@development")
devtools::install_github("PredictiveEcology/map@development")
devtools::install_github("PredictiveEcology/LandR@development") # Updates SpaDES.tools and SpaDES.core quickPlot
devtools::install_github("ianmseddy/LandR.CS@master") # Climate sensitivity in LandR

```

## Setting up directories and paths for the simulation

First, make sure you have the correct R version. These models were created using 
the following R version and might not workcorrectly in other versions:

```{r rVersion}

message(paste0("This model uses R version 3.5.2 (2018-12-20). Your session runs ", 
               sessionInfo()[["R.version"]][["version.string"]]))

```

Second, load all needed dependencies. 

```{r libraries}

library("LandR")
library("SpaDES")
library("raster")
library("plyr"); library("dplyr")
library("magrittr") # for piping

```

After having all installed correctly, we need to make sure all the submodules are synced to your machine:

```{r initSubmodules, eval = FALSE}

# system("git submodule init", wait = TRUE) # Use only the first time you are running the project
# system("git submodule sync | git submodule update --init --recursive --remote", wait = TRUE) # Use only the first time you are running the project
# system(paste0("cd ", getwd(),
#               " && git submodule foreach git fetch"), wait = TRUE) # Only need to run when you need to fetch other branches
system(paste0("cd ", getwd(),
              " && git submodule foreach git pull"), wait = TRUE)
system(paste0("cd ", getwd(),
              " && git pull"), wait = TRUE)
message("These are the specific commits and branches of each submodule:")
system("git submodule", wait = TRUE) # checks if the branches and commits you are using are the correct ones

# Submodules and commits used in V3
# ee593bdc17cd434c7d29588eed10bdfef8f2c6d6 modules/Biomass_regeneration (heads/development)
# ff8672f5ebd39c422097949f849d8d08a73628d5 modules/Boreal_LBMRDataPrep (heads/development)
# 71fdbd42257b5102134098e3be0e29d5c6a57182 modules/LBMR (heads/development)
# 2aca6167850583693251b0847859a5ab6527d2c4 modules/LandR_BiomassGMOrig (heads/development)
# 1cb234f64493c19590b0ea24c6221d491bf06699 modules/birdsNWT (heads/master)
# e8fcf9c29cae36a510eabbcc8773b81f89dc5eae modules/caribouPopGrowthModel (heads/master)
# 48d28c298621bbcc9dab559e0e5a65205c6f232f modules/caribouRecDistRelationship (heads/master)
# 3e1fb3ba63ac29b8386bebbff5ce833ee2c77d7a modules/fireSense_NWT_DataPrep (heads/master)
# e07c663a5c8e88bc9a89d7b499a8c32f79e02a88 modules/scfm (heads/development)
```

Now we can start setting up the simulations.
First we will set paths to the directories, the cloud cache folder and some 
options used by SpaDES.

```{r setup}

runVersion <- "V3"
isTest <- FALSE

user <- pemisc::user()
# Which computer is this being run on?
# Options are: BorealCloud, LocalMachine, 388
whichComputer <- if (user == "emcintir") "LocalMachine" else if (user == "tmichele") "BorealCloud" else "LocalMachine"

if (whichComputer == "BorealCloud" & basename(getwd()) != "NWT"){
  setwd(file.path(getwd(), "NWT"))
}

# Source all common functions
invisible(sapply(X = list.files(file.path(getwd(), "functions"), full.names = TRUE), FUN = source))

paths <- pathsSetup(whichComputer = whichComputer, isTest = isTest)
if (length(paths$modulePath) == 1) paths$modulePath <- c(paths$modulePath, file.path(paths$modulePath, "scfm/modules"))

if (pemisc::user() %in% c("Tati", "tmichele")) {
    setTempFolder(paths = paths, setTmpFolder = TRUE, usr = user)
}

# <<!!!>> ATTENTION <<!!!>>

# If setTmpFolder == TRUE, a temporary folder will be created inside the cache folder set. 
# This can/should be changed later for other projects using:

# ===> In Windows:
# file.edit(file.path(Sys.getenv('R_USER'), '.Renviron'))
# Change the path in TMPDIR to the desired path to temp folder and save the file. 
# Restart your R session for the changes to take effect.

# ===> In Linux/MacOS:
# tryCatch(library(unixtools),
#   error = function(e) install.packages("unixtools", repos = 'http://www.rforge.net/'))
#   unixtools::set.tempdir(<path/to/tempFolder>)
# Restart your R session for the changes to take effect.

# We also need to set a 'scratch' temporary folder for raster (if our home folder doesn't have enough space)
maxMemory <- 5e+12
scratchDir <- checkPath(path = paste0("/mnt/tmp/rasterTMP/", user), create = TRUE)
#Here we check that the creation of the folder worked (we might have problems with writting access, only tested with my own user)
if(dir.create(scratchDir)) system(paste0("sudo chmod -R 777 /mnt/tmp/rasterTMP"), wait = TRUE) 
rasterOptions(default = TRUE)
options(rasterMaxMemory = maxMemory, rasterTmpDir = scratchDir)

# Sessting up the cache folder: it is hosted in the project's GDrive
cloudFolderID <- "https://drive.google.com/open?id=1PoEkOkg_ixnAdDqqTQcun77nUvkEHDc0"
tilePath <- file.path(paths$outputPath, "tiles")

# Setting all SpaDES options to be used in the project
.plotInitialTime <- NA
opts <- options(
  "future.globals.maxSize" = 1000*1024^2,
  "LandR.assertions" = FALSE,
  "LandR.verbose" = 1,
  "map.dataPath" = paths$inputPath,
  "map.overwrite" = TRUE,
  "map.tilePath" = tilePath,
  "map.useParallel" = TRUE, #!identical("windows", .Platform$OS.type),
  "reproducible.futurePlan" = FALSE,
  "reproducible.inputPaths" = if (pemisc::user("emcintir")) "~/data" else NULL,
  "reproducible.quick" = FALSE,
  "reproducible.overwrite" = TRUE,
  "reproducible.useMemoise" = TRUE, # Brings cached stuff to memory during the second run
  "reproducible.useNewDigestAlgorithm" = TRUE,  # use the new less strict hashing algo
  "reproducible.useCache" = TRUE,
  "reproducible.cachePath" = paths$cachePath,
  "reproducible.showSimilar" = FALSE,
  "reproducible.useCloud" = if (pemisc::user("emcintir")|pemisc::user("tmichele")) FALSE else TRUE,
  "spades.moduleCodeChecks" = FALSE, # Turn off all module's code checking
  "spades.useRequire" = FALSE, # assuming all pkgs installed correctly
  "pemisc.useParallel" = TRUE
)

SpaDES.core::setPaths(modulePath = paths$modulePath, inputPath = paths$inputPath, 
                      outputPath = paths$outputPath, cachePath = paths$cachePath)

```

## Creating study areas

The study area is comprised of the *BCR6* (Bird Conservation Regions no. 6) within the *Northwest Territories*.  
We have developed a specific function to select this area, which is cached both locally and remotely 
in a google drive's folder (`cloudFolderID`). This folder is sharable with all project team members.

```{r studyArea}
if (quickPlot::isRstudioServer()) options(httr_oob_default = TRUE)

Edehzhie.url <- "https://drive.google.com/open?id=1klq0nhtFJZv47iZVG8_NwcVebbimP8yT"
EdehzhieOfficial.url <- "https://drive.google.com/open?id=1fYvNPwovjNtTABoGcegrvdFGkNfCUsxf"
NWT.url <- "https://drive.google.com/open?id=1LUxoY2-pgkCmmNH5goagBp3IMpj6YrdU"
        
studyAreaEde <- cloudCache(prepInputs,
                           url = Edehzhie.url,
                           destinationPath = paths$inputPath[[1]],
                           cloudFolderID = cloudFolderID,
                           omitArgs = c("destinationPath", "cloudFolderID"))
        
studyArea <- cloudCache(prepInputs,
                        url = NWT.url, studyArea = studyAreaEde,
                        destinationPath = paths$inputPath[[1]],
                        cloudFolderID = cloudFolderID,
                        omitArgs = c("destinationPath", "cloudFolderID"))

studyAreaNWT <- cloudCache(prepInputs,
                        url = NWT.url,
                        destinationPath = paths$inputPath[[1]],
                        cloudFolderID = cloudFolderID,
                        omitArgs = c("destinationPath", "cloudFolderID"))
```

<!-- TATI STILL TO ADD FIRESENCE AND FEENIX-->
### Running `LandR`, `fireSense`, and `FEENIX` 

To run the first set of modules, both the parametrization model (`Boreal_LBMRDataPrep`) and the forest succession group of modules
(`LandR_Biomass`), we explicitly specify the modules to be run, and the running time for the simulations:

```{r run_LandR}

modulesLandR_SCFM <- list("scfmLandcoverInit", "scfmRegime", "scfmDriver", "scfmIgnition", "scfmEscape", "scfmSpread",
                          "Boreal_LBMRDataPrep", "LandR_BiomassGMOrig","Biomass_regeneration", "LBMR")

times <- list(start = 0, end = if (isTest) 3 else 100)

```

Then we need to set the parameters for the simulation call:

``` {r params}

# This raster to match contains only the uplands, it is 
rasterToMatch <- cloudCache(prepInputs, url = "https://drive.google.com/open?id=1fo08FMACr_aTV03lteQ7KsaoN9xGx1Df", 
                            studyArea = studyAreaNWT,
                            targetFile = "RTM.tif", destinationPath = paths$inputPath, 
                            useCloud = getOption("reproducible.useCloud", FALSE),
                            cloudFolderID = cloudFolderID, overwrite = TRUE, filename2 = NULL,
                            omitArgs = c("destinationPath", "cloudFolderID", "useCloud", "overwrite", "filename2"))

sppEquivCol <- "NWT"

#SCFM
defaultInterval <- 1.0
defaultPlotInterval <- 1.0
defaultInitialSaveTime <- NA 

# cacheId of the BorealDataPrep with the correct uniqueEcoregionGroups = "b2209ccb1cb19ee1"
# Use it explicitly if cache doesn't work for some reason

parameters <- list(
  #SCFM
    ".progress" = list(type = "text", interval = 1),
    scfmLandcoverInit = list(
    ".plotInitialTime" = NULL
  ),
  scfmIgnition = list(
    "pIgnition" = 0.0001,
    "returnInterval" = defaultInterval,
    "startTime" = times$start,
    ".plotInitialTime" = NA,
    ".plotInterval" = defaultPlotInterval,
    ".saveInitialTime" = defaultInitialSaveTime,
    ".saveInterval" = defaultInterval),
  scfmEscape = list(
    "p0" = 0.05,
    "returnInterval" = defaultInterval,
    "startTime" = times$start,
    ".plotInitialTime" = NA,
    ".plotInterval" = defaultPlotInterval,
    ".saveInitialTime" = defaultInitialSaveTime,
    ".saveInterval" = defaultInterval),
  scfmSpread = list(
    "pSpread" = 0.235,
    "returnInterval" = defaultInterval,
    "startTime" = times$start,
    ".plotInitialTime" = times$start,
    ".plotInterval" = defaultPlotInterval,
    ".saveInitialTime" = defaultInitialSaveTime,
    ".saveInterval" = defaultInterval),
  scfmRegime = list(fireCause=c("L", "H")),
  scfmDriver = list(targetN = 1500),
  # LandR_Biomass
  LBMR = list(
    ".useParallel" = 3,
    ".plotInitialTime" = NA,
    ".saveInitialTime" = NA,
    "seedingAlgorithm" = "wardDispersal",
    ".useCache" = FALSE,
    "successionTimestep" = 10,
    "initialBiomassSource" = "cohortData"),
  LandR_BiomassGMOrig = list( # dev branch
    "growthInitialTime" = 0,
    "successionTimestep" = 10,
    "growthAndMortalityDrivers" = "LandR"),
  Boreal_LBMRDataPrep = list(
    # "cacheIDmodelBiomass" = "b2209ccb1cb19ee1", #THIS CACHE WAS FROM V1. Not passable anymore as of 13/03 (reverted changes). Cache for V3 = "cf805cd9582a9797"
    "useCloudCacheForStats" = if (pemisc::user("tmichele")) FALSE else TRUE,
    "sppEquivCol" = sppEquivCol,
    "successionTimestep" = 10,
    "pixelGroupAgeClass" = 10,
    ".useCache" = c(".inputObjects", "init")
  )
)

```

Now we have to set the objects. The first object is a list of trees of interest:

```{r treeSp, echo = FALSE}

# Tree species specified for the project (see "Meeting minute January 16th, 2019" from Google Drive)
# spTable <- data.frame(CommonName = c("Jack pine", "Black spruce", "White spruce", 
#                                      "Balsam poplar", "Trembling aspen", "Paper birch"),
#                       ScientificName = c("Pinus banksian", "Picea mariana", "Picea glauca", 
#                                          "Populus balsamifera", "Populus tremuloides", 
#                                          "Betula papyrifera"),
#                       LandR = c("Pinu_ban", "Pice_mar", "Pice_gla", "Popu_bal", 
#                                 "Popu_tre", "Betu_pap"))
# knitr::kable(spTable)
# Bird model's tree species [30JAN19]:
NWTsp <- c("Abie_Bal", "Betu_Pap", "Lari_Lar", "Pice_Gla",
                "Pice_Mar", "Pinu_Ban", "Pinu_Con", "Popu_Bal", "Popu_Tre")

# Equivalency table for tree species
data("sppEquivalencies_CA", package = "LandR")

# Make NWT spp equivalencies
# Popu_Tri == Popu_Bal in NWT
# Quer_mac in LandR needs to be Quer_Mac in NWT
sppEquivalencies_CA[, NWT := c(Abie_Bal = "Abie_Bal", 
                               Betu_Pap = "Betu_Pap", 
                               Lari_Lar = "Lari_Lar", 
                               Pice_Gla = "Pice_Gla",
                               Pice_Mar = "Pice_Mar", 
                               Pinu_Ban = "Pinu_Ban", 
                               Pinu_Con = "Pinu_Con", 
                               Popu_Bal = "Popu_Bal", 
                               Popu_Tre = "Popu_Tre")[Boreal]]

sppEquivalencies_CA <- sppEquivalencies_CA[!is.na(NWT)]
sppEquivalencies_CA$EN_generic_short <- sppEquivalencies_CA$NWT
# Fix EN_generic_short for plotting. Needs to have all names. Don't have time now.

# knitr::kable(sppEquivalencies_CA[NWT %in% NWTsp])
# create color palette for species used in model

sppColors <- LandR::sppColors(sppEquiv = sppEquivalencies_CA, sppEquivCol = sppEquivCol,
                              palette = "Set3")
mixed <- structure("#D0FB84", names = "Mixed")
sppColors[length(sppColors)+1] <- mixed
attributes(sppColors)$names[length(sppColors)] <- "Mixed"

```

And finally, we load the objects used by this group of modules:

``` {r objects}

.objects <- list(
  "rasterToMatch" = rasterToMatch,
  "studyAreaLarge" = studyAreaNWT,
  "sppEquiv" = sppEquivalencies_CA,
  "sppEquivCol" = sppEquivCol,
  "sppColors" = sppColors,
  "omitNonVegPixels" = TRUE,
  "cloudFolderID" = cloudFolderID,
  "studyArea" = studyAreaNWT
  )

```

After supplying the objects, we run the simulation initialization functionI'll install i, passing all arguments of interest:

``` {r simInit}

succTS <- seq(times$start, times$end, 
                       by = parameters$LBMR$successionTimestep)
outputsLandR <- data.frame(
  objectName = rep(c("burnMap",
                 "cohortData",
                 "simulationTreeOutput",
                 "summaryBySpecies",
                 "summaryBySpecies1",
                 "simulationOutput",
                 "pixelGroupMap",
                 "simulatedBiomassMap",
                 "ANPPMap",
                 "mortalityMap"), each = length(succTS)),
  saveTime = c(rep(succTS, times = 10))
)

```

And finally the simulation call (note that the argument `debug = 2` lists all processes that are happening):

```{r call}

# assign(paste0("LandR_SCFM_", runVersion), value = simInitAndSpades(times = times, params = parameters,
#                     modules = modulesLandR_SCFM,
#                     objects = .objects, paths = paths,
#                     loadOrder = unlist(modulesLandR_SCFM),
#                     outputs = outputsLandR, debug = 2))

# To save a run
# if (!isTest){
# saveRDS(object = get(paste0("LandR_SCFM_", runVersion)), 
#         file = file.path(paths$outputPath, paste0("birdsFireCaribou", runVersion,"_", toupper(format(Sys.time(), "%d%b%y")))))
# }
```

### Climate sensitive forest succession

Now we try running LandR with climate sensitivity and fireSense
```{r LandR_CS}

start_year <- 0
end_year <- 2
times <- list(start = start_year, end = end_year)

library("googledrive")

tryCatch(googledrive::drive_download(file = googledrive::as_id("1EetOiGxAq-QTZCVU9Q6Y3I26tqjZm3Oi"), 
                            path = file.path(getPaths()$inputPath, "fireSense_FrequencyFitted.rds")), 
         error = function(e){message("Files are already present and won't be overwritten")})
tryCatch(googledrive::drive_download(file = googledrive::as_id("11CrK9PfNJzkU5cZg9-JYYzyr-VP23W0x"), 
                            path = file.path(getPaths()$inputPath, "fireSense_EscapeFitted.rds")), 
         error = function(e){message("Files are already present and won't be overwritten")})

inputs <- data.frame(
   files = c(file.path(getPaths()$inputPath, "fireSense_FrequencyFitted.rds"), 
             file.path(getPaths()$inputPath, "fireSense_EscapeFitted.rds")),
   functions = c("base::readRDS", "base::readRDS"),
   stringsAsFactors = FALSE
)

modulesLandR_fS_FEENIX <- c("climate_NWT_DataPrep", 
                            "MDC_NWT_DataPrep", 
                            "fireSense_NWT_DataPrep", 
                            "fireSense_FrequencyPredict", 
                            "fireSense_EscapePredict", 
                            "LBMR2LCC_DataPrep", 
                            "fireSense_NWT", 
                            "PSP_Clean",
                            "gmcsDataPrep",
                            "Boreal_LBMRDataPrep", 
                            "LandR_BiomassGMOrig",
                            "Biomass_regeneration", 
                            "LBMR")

objectSynonyms <- list(c("biomassMap", "kNN_Biomass"), 
                       c("standAgeMap", "kNN_AgeMap"),
                       c("vegMap", "LCC2005"),
                       c("VRUG", "Vrug"))

.objects <- c(.objects, list(objectSynonyms = objectSynonyms))

parametersFireSense <- list(
  climate_NWT_DataPrep = list(
    rcp = 45, # 45 or 85
    gcm = "CanESM2" # One of CanESM2, GFDL-CM3, HadGEM2-ES, MPI-ESM-LR 
  ),
  fireSense_FrequencyPredict = list(
    f = 250 / 10000, # fireSense_FrequencyFit was fitted using the 10km resolution, predictions are made at the 250m resolution?
    data = c("MDC06", "LCC")
  ),
  fireSense_NWT_DataPrep = list(
    train = FALSE
  ),
  fireSense_EscapePredict = list(
    data = c("MDC06", "LCC")
  ),
  LBMR2LCC_DataPrep = list(
    .runInitialTime = 0
  ),
  fireSense_NWT = list(
    .runInitialTime = 0    
  )
)

parameters$LandR_BiomassGMOrig$growthAndMortalityDrivers <- "LandR.CS"
parameters <- c(parameters, parametersFireSense)

runVersion <- "V1"
assign(paste0("LandR_FireSense_", runVersion), 
       value = simInitAndSpades(inputs = inputs, times = times, 
                                params = parameters,
                                modules = modulesLandR_fS_FEENIX,
                                objects = .objects, paths = paths,
                                loadOrder = unlist(modulesLandR_fS_FEENIX),
                                outputs = outputsLandR, debug = 2))


# AFTER RUNNING, NEED TO MASK OUT THE NON FORESTED PIXELS!
# LCC05 -> So we can exclude the non-forest/non-burned classes
# LCC05 <- LandR::prepInputsLCC(destinationPath = tempdir(),
#                                       studyArea = studyAreaNWT,
#                                       rasterToMatch = rasterToMatch)
# forestClasses <- c(1:15, 34:35)
# rasterToMatch[!LCC05 %in% forestClasses] <- NA

```
<!-- TATI STILL TO ADD-->
#### Outputs from `LandR`, `FireSense`, and `FEENIX` 

##### Figure: Graph of total biomass per tree species per year. These data serve as an input to the `BirdsNWT` module

##### Figure: GIF map of deciduous/non-deciduous trees proejcted at every 10 years. These data serve as an input for the `caribouRSFModel` module

##### Figure: GIF maps of recent and old fires projected at every 10 years. These data serve as an input for both `caribouRSFModel` and `caribouPopGrowth` modules.

```

```

### Running `BirdsNWT` using the succession model

```{r birds}

dayOfRecording <- today <- toupper(format(Sys.time(), "%d%b%y"))
dayOfRecording <- "19MAR19"

isTEST <- FALSE

if (isTEST){
    dayOfRecording <- "19MAR19"
}

# Source functions in R folder
invisible(sapply(X = list.files(file.path(getwd(), "R"), full.names = TRUE), FUN = source))

# Set a storage project folder
workDirectory <- getwd()
message("Your current temporary directory is ", tempdir())

create <- if (isTEST) NULL else TRUE 
checkInputPath <- tryCatch(checkPath(file.path(getwd(), "outputs", dayOfRecording)), error = function(e) NULL)
if (is.null(checkInputPath)){
  inpPath <- tempdir()
} else {
  inpPath <- checkInputPath
}

checkOutputPath <- tryCatch(checkPath(file.path(getwd(), "outputs", today), create = create), error = function(e) NULL)
if (is.null(checkOutputPath)){
  outPath <- tempdir()
} else {
  outPath <- checkOutputPath
}

setPaths(modulePath = file.path(getwd(), "modules"), 
         inputPath = inpPath, outputPath = outPath)
getPaths() # shows where the 4 relevant paths are

times <- list(start = 0, end = 100)

modulesBirds <- list("birdsNWT")

parametersBirds <- list(
  .progress = list(type = "text", interval = 1), # for a progress bar
birdsNWT = list(
    "baseLayer" = 2005,
    "overwritePredictions" = TRUE,
    "useTestSpeciesLayers" = FALSE, # Set it to false when you actually have results from LandR_Biomass simulations to run it with
    "useParallel" = TRUE, # Using parallel in windows is currently not working.
    "predictionInterval" = 10
  )
)
cloudFolderID <- "https://drive.google.com/open?id=1PoEkOkg_ixnAdDqqTQcun77nUvkEHDc0"
# Passing the uplandsRaster here makes sure that all computers can use it as the operations take up a lot of memory
uplandsRaster <- prepInputs(targetFile = "uplandsNWT250m.tif", 
                            url = "https://drive.google.com/open?id=1EF67NCH7HqN6QZ0KGlpntB_Zcquu6NJe", 
                            destinationPath = getPaths()$inputPath, filename2 = NULL)

.objectsBirds <- list(
  "birdsList" = c("BBWA", "BOCH", "RBNU"),
  "sppEquiv" = sppEquivalencies_CA,
  "sppEquivCol" = sppEquivCol,
  "uplandsRaster" = uplandsRaster,
  "rasterToMatch" = rasterToMatch,
  "cloudFolderID" = cloudFolderID,
  "studyArea" = studyAreaNWT)

assign(paste0("birds", runVersion), value = simInitAndSpades(times = times, params = parametersBirds,
                    modules = modulesBirds,
                    objects = .objectsBirds,
                    loadOrder = unlist(modulesBirds), debug = 2))
```
<!-- TATI STILL TO ADD-->
#### Outputs from the `BirdsNWT` module 
##### Figure: Bird species abundance maps (one for each species), predicted at every 10 years.

<!-- TATI STILL TO ADD-->
### Running the `anthropogenic` module 

#### Outputs from the `anthropogenic` module 

##### Figure: Static map of 2010 RoadDenisty (presence/absence). These data serve as an input for the `caribouRSFModel`

##### Figure: Static map of 2010 RoadDensity (presence/absence) buffered by 500m. These data serve as an imput for the `caribouPopGrowth` module

<!-- TATI STILL TO ADD-->
### Running `caribouRSFModel` 

#### Outputs from `caribouRSFModel` 

#### Figure: GIF map of caribou relative selection across the NWT Taiga plains every 10 years.

#### Figure: GIF map of caribou relative selection uncertaintly across the NWT Taiga plains every 10 years. Uncertainty is measured for each pixel as the standard deviation of the projected mean relative selection value. 

### Running `caribouPopGrowthModel`
```{r caribou}

modulesCaribou <- list("caribouPopGrowthModel", "caribouRSF")

parametersCaribou <- list(
  # Caribou
  caribouPopGrowthModel = list(
    ".plotInitialTime" = NULL,
    "recoveryTime" = 40
  )
)

.objectsCaribou <- list(
  "rasterToMatch" = rasterToMatch,
  "cloudFolderID" = cloudFolderID,
  "studyArea" = studyAreaNWT
  )

# assign(paste0("caribous", runVersion), value = simInitAndSpades(times = times, params = parametersCaribou,
#                     modules = modulesCaribou,
#                     objects = .objectsBirds, paths = paths,
#                     loadOrder = unlist(modulesCaribou),
#                     outputs = outputsLandR, debug = 2))
```

#### Extracting some posthoc plots

```{r extra_plots}

df <- comparePredictions(polyList = names(LandR_SCFM_V3$scfmDriverPars), simList = LandR_SCFM_V3) %>%
  data.table::rbindlist()

firePlots <- firePosthocPlots(df = df)

lapply(X = firePlots, FUN = print)

# Creating birds images and gif
createBirdsGIF(simList = birdsFireCaribouV2, version = "V2")

# For the cohortData biomass, need to use $ [ FIX ] using the padded function 
cohortData <- rbindlist(lapply(X = seq(times$start, times$end, by = 10), FUN = function(year){
  if (year != 100 & year != 0)
    cohort <- readRDS(file.path(getwd(), paste0("outputs/14MAR19/cohortData_year0", year, ".rds")))
  if  (year == 100)
    cohort <- readRDS(file.path(getwd(), paste0("outputs/14MAR19/cohortData_year", year, ".rds")))
  if (year == 0)
    cohort <- readRDS(file.path(getwd(), paste0("outputs/14MAR19/cohortData_year00", year, ".rds"))) 
  cohort$year <- year
  return(cohort)
}))

pixelGroupMapList <- lapply(X = seq(times$start, times$end, by = 10), FUN = function(year){
  if (year != 100 & year != 0)
    pxl <- readRDS(file.path(getwd(), paste0("outputs/14MAR19/pixelGroupMap_year0", year, ".rds")))
  if  (year == 100)
    pxl <- readRDS(file.path(getwd(), paste0("outputs/14MAR19/pixelGroupMap_year", year, ".rds")))
  if (year == 0)
    pxl <- readRDS(file.path(getwd(), paste0("outputs/14MAR19/pixelGroupMap_year00", year, ".rds"))) 
  return(pxl)
})
names(pixelGroupMapList) <- paste0("Year", seq(times$start, times$end, by = 10))

biomassMapAll <- lapply(X = seq(times$start, times$end, by = 10), function(year){
  cohortMap <- SpaDES.tools::rasterizeReduced(cohortData[year == year, list(pixelGroup, sumB = sum(B)), by = "pixelGroup"], 
                                                  pixelGroupMapList[[paste0("Year", year)]], "sumB", "pixelGroup")
  names(cohortMap) <- paste0("biomassYear", year)
  return(cohortMap)
})
names(biomassMapAll) <- paste0("biomassYear", seq(times$start, times$end, by = 10))
biomassMapAll <- stack(biomassMapAll)
writeRaster(x = biomassMapAll, filename = file.path(paths$outputPath, "biomassMapStack"))

```
<!-- TATI STILL TO ADD-- >
#### Outputs from `caribouPopGrowthModel` 

#### Figure: Annual plot of projected lambda across each requested study region of the NWT. 

#### Figure: Annual plot of projected lambda uncertainty across each requested study region of the NWT. Uncertainty is measured for each study region as the standard deviation of the projected lambda values.



# Intgrated modules final components of Item 3: Species co-occurence through community metrics, and an analysis of the Edehzhie


<!-- ANA STILL TO ADD -->
\textcolor{blue}{comm_metricsNWT}: This module computes a series of avian community metrics based on the suite of species-level
                                   predicted abundance maps provided from the 'birdsNWT' module. 
                                   
The community metrics computed as part of the `comm_metricsNWT` include:

Expected Species Richness:

Shannon Diversity Index:



<!-- TATI STILL TO ADD FIGURES AND TABLES -->
\textcolor{blue}{Edehzhie}: For the third deliverable, we have repeated the analysis developed for the whole BCR6 within NWT territory
                            described above, but only within the proposed area of Edehzhie. Bird species abundance (`birdsNWT`),
                            caribou population growth (`caribouPopGrowthModel`), and caribou and relative habitat selection
                            (`caribouRSFModel`) predictions from this polygon (area) were compared to predictions on three similar
                            areas randomly located north, west, and south of the Edehzhie area. These results are presented below.

#### Figure: One bird species example, 10 plots of prediction for the three areas one next to the other (gif for html/all other species)

#### Figure: Caribou population growth on the three areas

#### Figure: RSF over the three areas

#### Table: Summarized RSF mean values





# Literature cited 
Araújo, M. B., W. Thuiller, P. H. Williams and I. Reginster. 2005. Downscaling European species atlas distributions to a finer
resolution: implications for conservation planning. Global Ecology and Biogeography, 14(1):17-30.

Armstrong, G. and S. Cumming. 2003. Estimating the cost of land base changes due to wildfire using shadow prices. Forest Science 49(5):
719–730.

Barker, N. K. S., P. C. Fontaine, S. G. Cumming, D. Stralberg, A. Westwood, E. M. Bayne, P. Sólymos, F. K. A. Schmiegelow, S. J. Song,
and D. J. Rugg. 2015. Ecological monitoring through harmonizing existing data: Lessons from the boreal avian modelling project.
Wildlife ociety Bulletin 39:480-487. http://dx.doi.org/10.1002/wsb.567

Barros, C., Y. Lou, E. J. B. McIntire, A. M. Chubaty, I. Eddy, D. Andison and S. Cumming. Empowering ecologists in a simulation
context: using R data for complex landscape modelling, the LandR study case. In preparation. 

Beaudoin, A., P. Y. Bernier, P. Villemaire, L. Guindon, and X. J. Guo. 2017. Tracking forest attributes across Canada between 2001 and
2011 using a k nearest neighbors mapping approach applied to MODIS imagery. Canadian Journal of Forest Research 48:85-93.
http://dx.doi.org/10.1139/cjfr-2017-0184

Bergeron, Y., D. Dominic, M. P. Girardin, and C. Carcaillet. 2010. Will climate change drive 21st century burn rates in Canadian boreal
forest outside of its natural variability: collating global climate model experiments with sedimentary charcoal data. International
Journal of Wildland Fire 19:1127-1139. doi: 10.1071/WF09092

Burton, A. C., F. E. C. Stewart, and J. T. Fisher. Scaling-down species distribution models: can large-scale models predict smaller
scale wildlife distribution? In review.

Chen, T. and C. Guestrin. 2016. XGBoost: A Scalable Tree Boosting System. In 22nd SIGKDD Conference on Knowledge Discovery and Data
Mining, 2016. http://arxiv.org/abs/1603.02754

Chubaty, A. M. and E. J. B.  McIntire. 2017. SpaDES: Develop and Run Spatially Explicit Discrete Event Simulation Models. R package
version, 2(0).

Cumming, S. G., K. L. Lefevre, E. Bayne, T. Fontaine, F. K. A. Schmiegelow, and S. J. Song. 2010. Toward conservation of Canada's
boreal forest avifauna: design and application of ecological models at continental extents. Avian Conservation and Ecology 5(2):8. 

Elith, J., J. R. Leathwick, and T. Hastie. 2008. A working guide to boosted regression trees. Journal of Animal Ecology 77:802-813. 

Environment Canada. 2012. Recovery Strategy for the Woodland Caribou (*Rangifer tarandus caribou*), Boreal population, in Canada.
Species at Risk Act Recovery (138 pp.) Accessed online August 10, 2018 at
http://publications.gc.ca/collections/collection_2012/ec/En34-140-2012-eng.pdf.

Environment Canada. 2011. Scientific Assessment to Inform the Identification of Critical Habitat for Woodland Caribou (*Rangifer
tarandus caribou*), Boreal Population, in Canada: 2011 Update. Ottawa, Ontario, Canada. 102 pp. plus appendices.

Environment Canada. 2008. Scientific Review for the Identification of Critical Habitat for Woodland Caribou (*Rangifer tarandus
caribou*), Boreal Population, in Canada. August 2008. Ottawa: Environment Canada. 72 pp. plus 180 pp Appendices.

Fretwell, S. D., and J. H. J. Lucas. 1970. On territorial behavior and other factors influencing habitat distribution in birds. Acta
Biotheoretica 19:16–36.

Government of the Northwest Territories. 2019. A Framework for Boreal Caribou Range Planning: Revised Draft - Appendices. Environment
and Natural Resources, Government of the Northwest Territories, Yellowknife, NT. 38 + ii pp.

Hatter, I. W. and W. A. Bergerud. 1991. Moose recruitment, adult mortality and rate of change. Alces 27:65-73.

Hervieux, D., M. Hebbelwhite, D. Stepinsky, S. Bacon and S. Boutin. 2014. Managing wolves (*Canis lupus*) to recover threatened
woodland caribou (*Rangifer tarandus caribou*) in Alberta. Cananadian Journal of Zoology 92(12):1029-1037. doi: 10.1139/cjz-2014-0142

Hijmans, R. J., S. Phillips, J. Leathwick, and J. Elith. 2011. Package ‘dismo’. Available online at http://cran.r
project.org/web/packages/dismo/index.html.

Holling, C. S. 1992. Cross‐scale morphology, geometry, and dynamics of ecosystems. Ecological monographs 62(4): 447-502.

Levin, S. A. 1992. The problem of pattern and scale in ecology: the Robert H. MacArthur award lecture. Ecology 73(6):pp.1943-1967.

Manly, B. F. J., L. L. McDonald, D. L. Thomas, T. L. McDonald, and W. P. Erickson, editors. 2002. Resource selection by animals:
statistical analysis and design for field studies. Second Edition. Kluwer, Boston, USA.

Mcloughlin, P. D., E. Dzus, B. O. B. Wynes, and S. Boutin. 2003. Declines in populations of woodland caribou. The Journal of Wildlife
Management 67(4):755-761.

Riitters, K. H. 2005. Downscaling indicators of forest habitat structure from national assessments. Ecological indicators 5(4):273-279.

Sappington, J. M., K. M. Longshore and D. B. Thomson. 2007. Quantifiying Landscape Ruggedness for Animal Habitat Anaysis: A case Study
Using Bighorn Sheep in the Mojave Desert. Journal of Wildlife Management. 71(5):1419 -1426. 

Sólymos, P., S. M. Matsuoka, E. M. Bayne, S. R. Lele, P. Fontaine, S. G. Cumming, D. Stralberg, F. K. A. Schmiegelow, and S. J. Song.
2013. Calibrating indices of avian density from non-standardized survey data: making the most of a messy situation. Methods in Ecology
and Evolution 4:1047-1058. http://dx.doi.org/10.1111/2041-210x.12106

Sorensen, T., P. D. McLoughlin, D. Hervieux, E. Dzus, J. Nolan, B. Wynes and S. Boutin. 2008. Determining Sustainable Levels of
Cumulative Effects for Boreal Caribou. J. Wildlife Manag., 72, 900–905. doi: 10.2193/2007-079

Stralberg, D., S. M. Matsuoka, A. Hamann, E. M. Bayne, P. Sólymos, F. K. A. Schmiegelow, X. Wang, S. G. Cumming, and S. J. Song. 2015.
Projecting boreal bird responses to climate change: the signal exceeds the noise. Ecological Applications 25:52–69.
http://dx.doi.org/10.1890/13-2289.1

Sutherland, G. D., F. K. A. Schmiegelow, C-A. Johnson, E. J. B. McIntire, M. LeBlond and R. Jagodzinski. A simple empirically-linked
demographic model to estimate likelihoods of recovering population of boreal caribou (*Rangifer tarandus caribou*). In preparation.

Wiens, J. A. 1989. Scale in ecology. Functional Ecology 3:385-397.

Wiens J. A., D. Stralberg, D. Jongsomjit, C. A. Howell and M. A. Snyder. 2009. Niches, models, and climate change: assessing the
assumptions and uncertainties. Proceedings of the National Academy of Sciences 106(2):19729-36.

Yip, D. A., L. Leston, E. M. Bayne, P. Sólymos, and A. Grover. 2017. Experimentally derived detection distances from audio recordings
and human observers enable integrated analysis of point count data. Avian Conservation and Ecology 12.
http://dx.doi.org/10.5751/ACE00997-120111
